!function(a,n){"use strict";var r=a.PROTOCOL;a.inherit("VideoPlayer","Common.Publisher",function(e){e=e||{},this.data=e.data,this.country=e.country,this.node,this.campaign,this.nid,this.duration,this.isVast=!1,this.isVertical=!1,this.isFullScreen=!1,this.currentTime=0,this.currentPercentage=0,this.timer},{DEFAULT_VOLUME:.8,VIDEO_FILE_URL_FORMAT:r+"//jsv.popin.cc/{{nid}}/video.mp4",VIDEO_IMP_REQUEST_URL:r+"//discoveryplus.popin.cc/popin_discovery/video",CALENDAR_URL:"https://addevent.com/dir/?client=aDoyjOXdmzdeHwNStmZG11131",CALENDAR_IMAGE_URL:"https://addevent.com/gfx/icon-calendar-t5.png",SNS_SHARE_URL:"http://share.popin.cc/getVideoDemo?popinvideotest=",CLASS_NAME_FULL_SCREEN:"full_screen",CLASS_NAME_ENDED:"ended",PR_TEXT:"PR",POWERED_TEXT:"ads by popIn",PROGRESS_BAR_HEIGHT:5,setup:function(){this._registerPublicMembers(this.data);var e=a.VideoPlayer,t=new a.Common.Message(this.country),i=this._generateNodes(this.data,t),n=new e.Screen({videoNode:i.getElementsByTagName("video")[0],canvasNode:i.getElementsByTagName("canvas")[0],progressBarHeight:this.PROGRESS_BAR_HEIGHT,progressBarColour:"#295ED4",src:this.src}),t=new e.Counter({node:i.querySelector("._popIn_video_play_count"),textFormat:t.get("video_counter")});this.screen=n,this.counter=t,this.node=i,this._sendCounterCommand("info"),this._addScreenEvents(n),this._addButtonEvents(i.querySelector("._popIn_video_end_replay_button"),i.querySelector("._popIn_video_end_detail_button"),i.querySelector("._popIn_video_more"),this.hasSNSButtons?Array.apply(null,i.getElementsByClassName("_popIn_share_button_link")):void 0);t=a.Common.NodeObserver;t.addTarget({node:i,onInView:this._onInView.bind(this)}),n.setup(),t.start()},_registerPublicMembers:function(e){var t=e.video;this.campaign=e.campaign,this.nid=e.nid,this.playTimeSeconds=""===t.play_time_seconds?void 0:Number(t.play_time_seconds),this.src=this.VIDEO_FILE_URL_FORMAT.replace("{{nid}}",e.nid),this.url=e.url,this.isVertical=t.background||"vertical"===t.type,this.isVast="vast"===e.type,this.hasCalendar=!!e.calendar,this.hasSNSButtons=!!e.share,this.start=e.start||void 0,this.compvare=e.compvare||void 0,this.ClickTracking=e.ClickTracking||void 0,this.impression=e.Impression||void 0,this.firstQuartile=e.firstQuartile||void 0,this.midpoint=e.midpoint||void 0,this.thirdQuartile=e.thirdQuartile||void 0},_sendCounterCommand:function(e){e="op="+e+"&video="+this.data.nid+"&t="+Date.now();a.Common.Utils.requestByJSONP(this.VIDEO_IMP_REQUEST_URL+"?"+e,this._onImpResponse.bind(this))},_onImpResponse:function(e){e=e&&e.imp?e.imp:0;this.counter.update(e)},_addButtonEvents:function(e,t,i,n){if(e.addEventListener("click",this._onClickReplayButton.bind(this),!1),t.addEventListener("click",this._onClickDetailButton.bind(this),!1),i.addEventListener("click",this._onClickDetailButton.bind(this),!1),n)for(var o=0,s=n.length;o<s;o++)n[o].addEventListener("click",this._onClickSNSShareButton.bind(this),!1)},_onInView:function(){this.screen.play(),this.trigger("inView",this)},_onClickReplayButton:function(e){a.Common.Utils.killEvent(e),this.screen.replay(),this.trigger("replay",this)},_onClickDetailButton:function(e){a.Common.Utils.killEvent(e);e=e.currentTarget;n.open(e.href);e=!0===this.hasCalendar?"calendar":"link";this.trigger(e,this)},_onClickSNSShareButton:function(e){var t=e.currentTarget;a.Common.Utils.killEvent(e),n.open(t.href),this.trigger("share",this,t.dataset.type)},_addScreenEvents:function(e){e.on("click",this._onClick.bind(this)),e.on("ended",this._onEnded.bind(this)),e.on("play",this._onPlay.bind(this)),e.on("timeupdate",this._onTimeUpdate.bind(this)),e.on("loadedmetadata",this._onLoadedMetaData.bind(this))},_onPlay:function(){this.node.classList.remove(this.CLASS_NAME_ENDED)},_onEnded:function(){!0===this.isFullScreen&&this._exitFullScreen(),this.node.classList.add(this.CLASS_NAME_ENDED),this.trigger("ended",this)},_onClick:function(){!0===this.isFullScreen?this._exitFullScreen():this._requestFullScreen()},_requestFullScreen:function(){var e=this.screen.videoNode;!0===e.paused&&e.play(),this.node.classList.add(this.CLASS_NAME_FULL_SCREEN),this._changeFullScreen(!0),this.trigger("fullscreen",this)},_exitFullScreen:function(){this.node.classList.remove(this.CLASS_NAME_FULL_SCREEN),this._changeFullScreen(!1)},_changeFullScreen:function(e){var t=this.screen;t.isCancelUpdate=e,t.changeMuted(!e),this.isFullScreen=e},_onLoadedMetaData:function(e){this.duration=e.duration},_onTimeUpdate:function(e){var t=e.currentTime,i=Math.floor(t),n=Math.round(t/e.duration*100),t=5*Math.floor(n/5),e=this.currentTime,n=this.currentPercentage;this.currentTime=i,this.currentPercentage=t,e<i&&(2===i&&this._sendCounterCommand("imp"),this.trigger("progressTime",this)),n<t&&t<100&&this.trigger("progressPercentage",this)},_generateCalendarLink:function(e){var t=e.start.split(" "),i=e.end.split(" "),i=a.Common.Utils.convertObjectToParameterString({start:t[0]||void 0,end:i[0]||void 0,title:encodeURIComponent(e.title),date_format:e.date_format,starttime:t[1]||void 0,startext:t[2]||void 0,endtime:i[1]||void 0,endext:i[2]||void 0,service:n.navigator.userAgent.match(/iPhone/i)?"iCalendar":"google"});return this.CALENDAR_URL+"&"+i},_generateNodes:function(e,t){var i=e.calendar,n=this.hasCalendar,o=n?t.get("video_button_calendar"):t.get("video_button_detail"),s=n?this._generateCalendarLink(i):e.origin_url,i=n?this.CALENDAR_IMAGE_URL:void 0,n=e.video;return new a.VideoPlayer.VideoBuilder({pr:this.PR_TEXT,title:e.title,poweredText:this.POWERED_TEXT,description:n.description,backgroundImage:n.background,snsShareUrl:this.hasSNSButtons?this.SNS_SHARE_URL+this.nid:void 0,moreText:o,moreImage:i,moreUrl:s,detailText:o,replayButtonText:t.get("video_end_replay"),replayIconUrl:r+"//i.popincdn.com/videos/play.png",detailIconUrl:r+"//i.popincdn.com/videos/lp.png",detailUrl:s,src:this.src,defaultVolume:this.DEFAULT_VOLUME,errorMessage:"Cannot play videos in your browser."}).execute()}})}(window.PopIn,window),function(){"use strict";(window.PopIn||{}).createClass("VideoPlayer.Counter",function(e){e=e||{},this.node=e.node,this.textFormat=e.textFormat,this.count=0},{update:function(e){this.count=e,this.node.textContent=this.textFormat.replace("{{value}}",e)}})}(),function(){"use strict";(window.PopIn||{}).createClass("VideoPlayer.ProgressBar",function(e){e=e||{},this.x=e.x||0,this.y=e.y||0,this.width=e.width||0,this.height=e.height||0,this.colour=e.colour||"transparent",this.maxWidth=e.maxWidth},{update:function(e){this.width=Math.round(e*this.maxWidth)}})}(),function(i){"use strict";i.inherit("VideoPlayer.Screen","Common.Publisher",function(e){e=e||{},this.videoNode=e.videoNode,this.canvasNode=e.canvasNode,this.progressBar,this.progressBarColour=e.progressBarColour,this.progressBarHeight=e.progressBarHeight,this.context,this.width,this.height,this.currentTime=0,this.isUpdating=!1,this.isCancelUpdate=!1,this._timerKey=null},{INTERVAL:1e3/24,setup:function(){var e=this.canvasNode,t=this.videoNode;this.context=e.getContext("2d"),this.progressBar=new i.VideoPlayer.ProgressBar({height:this.progressBarHeight,colour:this.progressBarColour}),this._addEvents(t,e),this.isCancelUpdate=!1,t.load()},resize:function(e,t){this._resizeNode(this.videoNode,e,t)},_resizeNode:function(e,t,i){e.width=t,e.height=i},_addEvents:function(e,t){e.addEventListener("play",this.play.bind(this),!1),e.addEventListener("pause",this.pause.bind(this),!1),e.addEventListener("ended",this._onEnd.bind(this),!1),e.addEventListener("loadedmetadata",this._onLoadedMetaData.bind(this),!1),e.addEventListener("timeupdate",this._updateCanvas.bind(this),!1),this._addOnlyNotifyingEvent(t,"click",!1),this._addOnlyNotifyingEvent(e,"click",!1),this._addOnlyNotifyingEvent(e,"canplay",!1),this._addOnlyNotifyingEvent(e,"timeupdate",!1)},_addOnlyNotifyingEvent:function(e,t,i){i=i||!1,e.addEventListener(t,this._on.bind(this,t),i)},_drawRect:function(e,t){t.fillStyle=e.colour,t.fillRect(e.x,e.y,e.width,e.height)},_onLoadedMetaData:function(e){var t=e.currentTarget,i=t.videoWidth,n=t.videoHeight,e=n+this.progressBarHeight;this._resizeNode(this.canvasNode,i,e),this.progressBar.maxWidth=i,this.progressBar.y=n,this.duration=t.duration,this.width=i,this.height=e,this.trigger("loadedmetadata",t)},_updateFrame:function(){var e,t;!0!==this.isCancelUpdate&&!0!==this.isUpdating&&(this.isUpdating=!0,e=this.videoNode.currentTime+this.INTERVAL/1e3,t=this.duration,this.currentTime!==e&&(t<=e?(this.changeTime(t),this._onEnd()):this.changeTime(e),this.currentTime=e))},_onEnd:function(){this.pause(),this.trigger("ended",this.videoNode)},_updateCanvas:function(){var e=this.context,t=this.videoNode,i=this.width,n=this.height,o=this.progressBar,s=this.duration;e.clearRect(0,0,i,n),e.drawImage(t,0,0,t.videoWidth,t.videoHeight),o.update(t.currentTime/s),this._drawRect(o,e),this.isUpdating=!1},play:function(){null===this._timerKey&&(this._timerKey=setInterval(this._updateFrame.bind(this),this.INTERVAL),this.trigger("play",this.videoNode))},pause:function(){null!==this._timerKey&&(clearInterval(this._timerKey),this._timerKey=null,this.trigger("pause",this.videoNode))},replay:function(){this.changeTime(0),this.play()},changeMuted:function(e){this.videoNode.muted=e||!1},changeTime:function(e){this.videoNode.currentTime=e},_on:function(e,t){this.trigger(e,t.currentTarget)}})}(window.PopIn||{}),function(i){"use strict";var e=i.PROTOCOL;i.createClass("VideoPlayer.VideoBuilder",function(e){e=e||{},this.src=e.src,this.title=e.title||"",this.pr=e.pr||"",this.poweredText=e.poweredText||"",this.description=e.description||"",this.defaultVolume=e.defaultVolume,this.errorMessage=e.errorMessage||"",this.moreText=e.moreText||"",this.moreImage=e.moreImage,this.moreUrl=e.moreUrl,this.snsShareUrl=e.snsShareUrl,this.replayIconUrl=e.replayIconUrl,this.detailIconUrl=e.detailIconUrl,this.replayButtonText=e.replayButtonText||"",this.detailText=e.detailText||"",this.detailUrl=e.detailUrl||"",this.backgroundImage=e.backgroundImage||void 0},{SNS_SHARE_CONFIG:[{type:"facebook",urlFormat:"https://m.facebook.com/sharer.php?u={{url}}&t={{title}}",image:e+"//i.popincdn.com/videos/facebook.png"},{type:"twitter",urlFormat:"https://twitter.com/share?url={{url}}&text={{title}}",image:e+"//i.popincdn.com/videos/twitter.png"},{type:"line",urlFormat:"https://line.naver.jp/R/msg/text/?{{title}}{{url}}",image:e+"//i.popincdn.com/videos/line.png"}],VIDEO_TYPE:"video/mp4",PLAYER_CSS_OBJECT:{"._popIn_video_container":{position:"relative",background:"#ffffff",width:"100%",height:"auto",display:"block"},"._popIn_video_header":{width:"100%",margin:"0 0 5px"},"._popIn_video_pr":{display:"inline-block",color:"#fff",background:"rgb(239, 196, 57)",width:"20px",height:"20px","vertical-align":"middle","line-height":"20px","text-align":"center","font-size":"12px","border-radius":"3px"},"._popIn_video_title":{display:"inline-block","font-size":"14px","font-weight":"bold",margin:"0 0 0 5px"},"._popIn_video_screen":{position:"relative","box-sizing":"border-box",width:"100%",height:"auto",overflow:"hidden"},"._popIn_video_screen.has_background":{"background-position":"top center",padding:"0px 10%"},".has_background::before":{content:"''",position:"absolute",width:"110%",height:"110%",background:"inherit",top:"-5%",left:"-5%",filter:"brightness(150%) blur(5px)"},"._popIn_video_player":{position:"relative",display:"none",width:"inherit",height:"inherit"},"._popIn_video_canvas":{position:"relative",display:"block",margin:0,width:"inherit",height:"inherit",background:"#fff"},"._popIn_video_powered":{color:"rgb(204, 204, 204)","font-size":"13px","font-weight":"normal","text-align":"right",width:"100%"},"._popIn_video_information":{display:"block"},"._popIn_video_information_bottom":{display:"flex","justify-content":"space-between"},"._popIn_video_description":{"font-size":"14px","line-height":1.3,"word-break":"break-all","white-space":"normal",color:"#000","text-align":"left",margin:"5px 0"},"._popIn_video_description:empty":{display:"none"},"._popIn_video_play_count":{display:"inline-block","font-size":"14px","font-weight":"bolder","font-family":"san-serif",margin:"4px 0px 5px 5px",color:"rgb(103, 107, 118)"},"._popIn_video_more":{display:"inline-block",color:"#000","font-size":"11px","box-sizing":"border-box","line-height":2,"text-align":"center","font-weight":"normal","text-decoration":"none",border:"1px solid rgb(204, 204, 204)",padding:"4px 5px",background:"-webkit-gradient(linear, 0% 0%, 0% 100%, from(rgb(255, 255, 255)), to(rgb(235, 235, 235))) rgb(238, 238, 238)"},"._popIn_video_more.has_image":{padding:"6px 5px 4px 27px","background-position":"left 5px center","background-repeat":"no-repeat"},"._popIn_share_buttons":{position:"absolute",display:"flex","list-style":"none","justify-content":"center",left:0,bottom:0,width:"100%",height:"50px",padding:0,margin:0},"._popIn_share_button":{width:"32px",margin:"5px 10px",position:"relative","box-sizing":"border-box"},"._popIn_share_button_link":{position:"inherit",display:"block",width:"inherit",height:"inherit"},"._popIn_share_button_link > img":{width:"100%",height:"auto"},"._popIn_video_end_mask":{display:"none","justify-content":"center","align-items":"center",position:"absolute",left:0,top:0,width:"100%",height:"100%","z-index":1,color:"#fff",background:"rgba(0, 0, 0, 0.4)"},"._popIn_video_end_controller":{display:"block",width:"50%"},"._popIn_video_end_replay_button, ._popIn_video_end_detail_button":{display:"flex","justify-content":"flex-start","align-items":"center","text-decoration":"none",padding:0,margin:0,color:"#fff","font-size":"16px",background:"transparent",border:"none"},"._popIn_video_end_replay_button > img, ._popIn_video_end_detail_button > img":{display:"inline-block"},"._popIn_video_end_replay_button > p, ._popIn_video_end_detail_button > p":{padding:0,margin:0,"word-break":"keep-all"},"._popIn_video_end_detail_button > img":{display:"inline-block"},".ended ._popIn_video_end_mask":{display:"flex"},"._popIn_video_container.full_screen ._popIn_video_player":{position:"fixed",background:"#000000",top:0,left:0,width:"100%",height:"100%",margin:"0 auto",display:"block","z-index":9999}},execute:function(){var e=i.Common,t=e.CSSManager;return t.add(this.PLAYER_CSS_OBJECT),t.render(),new e.NodeBuilder(this._generateStructure()).build()},_generateStructure:function(){return{tagName:"div",classList:"_popIn_video_container",children:[this._generateHeader(),this._generateScreen(),this._generateVideoInformation()]}},_generateHeader:function(){return{tagName:"header",classList:"_popIn_video_header",children:[{tagName:"span",classList:"_popIn_video_pr",property:{textContent:this.pr}},{tagName:"span",classList:"_popIn_video_title",property:{textContent:this.title}}]}},_generateScreen:function(){var e=this.backgroundImage,t=void 0!==e;return{tagName:"div",classList:t?["_popIn_video_screen","has_background"]:"_popIn_video_screen",property:t?{style:{backgroundImage:"url("+e+")"}}:void 0,children:[{tagName:"video",classList:"_popIn_video_player",property:{playsinline:!0,muted:!0,volume:this.defaultVolume,preload:"auto",controls:!0},children:[{tagName:"source",property:{src:this.src,type:this.VIDEO_TYPE}},{tagName:"p",property:{textContent:this.errorMessage}}]},{tagName:"canvas",classList:"_popIn_video_canvas"},this.snsShareUrl?this._generateSNSButtonList():void 0,this._generateEndMask()]}},_generateVideoInformation:function(){var e=this.moreImage;return{tagName:"footer",classList:"_popIn_video_information",children:[{tagName:"div",classList:"_popIn_video_powered",property:{textContent:this.poweredText}},{tagName:"div",classList:"_popIn_video_description",property:{textContent:this.description}},{tagName:"div",classList:"_popIn_video_information_bottom",children:[{tagName:"div",classList:"_popIn_video_play_count"},{tagName:"a",classList:e?["_popIn_video_more","has_image"]:"_popIn_video_more",property:{style:{backgroundImage:e?"url("+e+")":void 0},href:this.moreUrl,target:"_blank",textContent:this.moreText}}]}]}},_generateSNSButtonList:function(){var e=encodeURIComponent(this.snsShareUrl),t=encodeURIComponent(this.title);return{tagName:"ul",classList:"_popIn_share_buttons",children:this._generateSNSButtons(e,t)}},_generateSNSButtons:function(e,t){for(var i,n,o=this.SNS_SHARE_CONFIG,s=[],a=0,r=o.length;a<r;a++)n=(i=o[a]).urlFormat.replace(/{{title}}/,t).replace(/{{url}}/,e),s.push(this._generateSNSButton(i.type,n,i.image));return s},_generateSNSButton:function(e,t,i){return{tagName:"li",classList:"_popIn_share_button",children:[{tagName:"a",classList:"_popIn_share_button_link",property:{href:t,target:"_blank",dataset:{type:e}},children:[{tagName:"img",property:{src:i}}]}]}},_generateEndMask:function(){return{tagName:"div",classList:"_popIn_video_end_mask",children:[{tagName:"div",classList:"_popIn_video_end_controller",children:[{tagName:"button",classList:"_popIn_video_end_replay_button",children:[{tagName:"img",property:{src:this.replayIconUrl}},{tagName:"p",property:{textContent:this.replayButtonText}}]},{tagName:"a",classList:"_popIn_video_end_detail_button",property:{href:this.detailUrl},children:[{tagName:"img",property:{src:this.detailIconUrl}},{tagName:"p",property:{textContent:this.detailText}}]}]}]}}})}(window.PopIn||{}),function(){"use strict";(window.PopIn||{}).createClass("Discovery.Module",function(e){e=e||{},this.apiHost=e.apiHost,this.media=e.media,this.abtest=e.abtest,this.device=e.device,this.country=e.country,this.popInUserId=e.popInUserId||"",this.targetUrl=e.targetUrl,this.beginTime=e.beginTime,this.pageCategory=e.pageCategory,this.commonCategory=e.commonCategory,this.channelId=e.channelId,this.logid=e.logid,this.loc=e.loc,this.smjId=e.smjId,this.tdTrackValue=e.tdTrackValue,this.tdCommonSendData=e.tdCommonSendData,this.logger=e.logger},{setup:function(){},_mergeTDCommonSendData:function(e){return Object.assign(e||{},this.tdCommonSendData)},_getElapsed:function(){return Math.round((Date.now()-this.beginTime)/1e3)}})}(),function(l){"use strict";l.inherit("Discovery.VideoModule",l.Discovery.Module,function(e){e=e||{},this.data=e.data||[],this.node,this._sentOptionalLogRequests=[],this._hasWrittenTrackingPixel=!1;e=this.constructor;void 0===e._playingVideoNids&&(e._playingVideoNids=[])},{PLAYABLE_COUNT_IN_SESSION:1,ONLY_SEND_LOG_EVENT_NAMES:["link","replay","calendar"],OPTIONAL_PERCENTAGE_LOG_DICTIONARY:{25:"firstQuartile",50:"midpoint",75:"thirdQuartile"},SESSION_STORAGE_KEY_HISTORY:"_video",setup:function(){var e=this._selectVideo(this.data),t=this.constructor._playingVideoNids;if(!1===e||!0===l.Common.Utils.includes(e.nid,t))return!1;t.push(e.nid);e=new l.VideoPlayer({data:e,country:this.country});return e.setup(),this._registerLoggerEvents(e),this.node=e.node,!0},_registerLoggerEvents:function(e){var t;e.on("progressTime",this._onProgressTime.bind(this)),e.on("progressPercentage",this._onProgressPercentage.bind(this)),e.on("ended",this._onEnded.bind(this)),e.on("fullscreen",this._onFullScreen.bind(this)),e.on("inView",this._onInView.bind(this)),e.on("share",this._onClickShare.bind(this));for(var i=0,n=this.ONLY_SEND_LOG_EVENT_NAMES.length;i<n;i++)t=this.ONLY_SEND_LOG_EVENT_NAMES[i],e.on(t,this._onlySendAllLog.bind(this,t))},_sendOptionalLogs:function(e,t,i){for(var n=0,o=e.length;n<o;n++)this._sendOptionalLog(e[n],t,i)},_sendOptionalLog:function(e,t,i){t=t||!1,i=i||!1;var n=l.Common.Utils;!0===i&&!0===n.includes(e,this._sentOptionalLogRequests)||(!0===t&&(e+="&t="+Date.now()),n.requestByImageBeacon(e),this._sentOptionalLogRequests.push(e))},_onlySendAllLog:function(e,t){this._sendAllVideoLog(e,t,!1)},_onClickShare:function(e,t){this._sendAllVideoLog("share_"+t,e,!1)},_onFullScreen:function(e){!0===e.isVast&&!0===Array.isArray(e.ClickTracking)&&this._sendOptionalLogs(e.ClickTracking,!1,!0),this._sendAllVideoLog("full",e,!1)},_onProgressTime:function(e){var t=e.currentTime||0;2===t&&(this._saveHistory(e.nid),this._sendOptionalTwoSecondsLog(e),this.logger.send("treasure",{db:"popin_media",table:"mediadna_clicks",uniqueId:"videoMediaDNA",data:this._mergeTDCommonSendData({campaign_id:e.campaign,timestamp:Date.now()})}),this._sendAllVideoLog("2s",e,!0)),3===t&&this._sendAllVideoLog("3s",e,!0),t===e.playTimeSeconds&&(this._sendOptionalPlayTimeSecondsLog(e),this._sendAllVideoLog("playTimeSeconds",e,!0))},_sendOptionalTwoSecondsLog:function(e){var t=this._createRequestUrl(e.url,{type:!0===e.isVertical?"vertical_imp":"imp",api_host:this.apiHost,target:void 0===e.playTimeSeconds?void 0:"m"});this._sendOptionalLog(t,!0,!0),!0===e.isVast&&!0===Array.isArray(e.start)&&this._sendOptionalLogs(e.start,!1,!1)},_sendOptionalPlayTimeSecondsLog:function(e){var t=this._createRequestUrl(e.url,{type:!0===e.isVertical?"vertical_imp":"imp",api_host:this.apiHost,target:"c"});this._sendOptionalLog(t,!0,!0),!0===e.isVast&&!0===Array.isArray(e.impression)&&this._sendOptionalLogs(e.impression,!1,!0)},_onProgressPercentage:function(e){var t,i=e.currentPercentage;i%25!=0&&95!==i||(t=this.OPTIONAL_PERCENTAGE_LOG_DICTIONARY[i],!0===e.isVast&&void 0!==t&&!0===Array.isArray(e[t])&&this._sendOptionalLogs(e[t],!1,!0),this._sendAllVideoLog(i,e,!0))},_onEnded:function(e){this._sendOptionalEndLog(e);var t=this._createSendDataForBasic("100",e.campaign,e.nid);t.r5+="|"+l.Common.Utils.generateR5Value({cc:this.commonCategory}),this.logger.send("basic",{type:"normal",uniqueId:"100",data:t}),this._sendTreasureLog("100",e,!0)},_sendOptionalEndLog:function(e){var t=this._createRequestUrl(e.url,{type:"end",api_host:this.apiHost});this._sendOptionalLog(t,!0,!0),!0===e.isVast&&!0===Array.isArray(e.complete)&&this._sendOptionalLogs(e.complete,!1,!0)},_createRequestUrl:function(e,t){t=l.Common.Utils.convertObjectToParameterString(t);return e+(!0===/\?/.test(e)?"&":"?")+t},_onInView:function(e){this._sendTreasureLog("imp",e,!0);e=e.data.tracking_pixel;!1===this._hasWrittenTrackingPixel&&e&&(l.Common.Utils.writeCodeInIframe(e),this._hasWrittenTrackingPixel=!0)},_sendAllVideoLog:function(e,t,i){i=i||!1,this._sendBasicLog(e,t,i),this._sendTreasureLog(e,t,i)},_sendBasicLog:function(e,t,i){this.logger.send("basic",{type:"normal",uniqueId:!0===i?e:void 0,data:this._createSendDataForBasic(e,t.nid,t.campaign)})},_sendTreasureLog:function(e,t,i){this.logger.send("treasure",{db:"popin_ads",table:"adlogs",uniqueId:!0===i?e:void 0,data:this._createSendDataForTreasure(e,t.campaign,t.nid)})},_createSendDataForBasic:function(e,t,i){return{url:encodeURIComponent(this.targetUrl),uid:l.Common.Uid.getUid(),type:this.device+"_video_"+e,nid:i,campaign:t,media:this.media,r5:"cc_video",r6:"video_imp"}},_createSendDataForTreasure:function(e,t,i){return{type:"video_"+e,api_host:this.apiHost,time_show_seconds:this._getElapsed(),nid:i,campaign:t,timestamp:Date.now()}},_selectVideo:function(e){for(var t,i,n=(l.Common.Storage.get("session",this.SESSION_STORAGE_KEY_HISTORY)||"").split("."),o=[],s=0,a=e.length;s<a;s++){t=e[s];for(var r=i=0,d=n.length;r<d;r++)n[r]===t.nid&&i++;i<=this.PLAYABLE_COUNT_IN_SESSION&&o.push(t)}return o[0]||!1},_saveHistory:function(e){var t=l.Common.Storage,i=this.SESSION_STORAGE_KEY_HISTORY,n=null===t.get("session",i)?e:n+"."+e;t.set("session",i,n)}})}(window.PopIn||{}),function(i){"use strict";i.createClass("Discovery.ArticleBuilder",function(e){e=e||{},this.data=e.data||[],this.template=e.template||{},this.title=e.title,this.containerId=e.containerId,this.infiniteSize=e.infiniteSize||0,this.infinitePages=e.infinitePages||0,this.imageInView=e.imageInView||!1,this.isTargetTop=e.isTargetTop||!1,this.isTargetBlank=e.isTargetBlank||!1,this.credit=e.credit||"",this.hasInfiniteAds=e.hasInfiniteAds||!1,this.aboutPageType=e.aboutPageType||"dialogue",this.aboutPageURL=e.aboutPageURL,this.ad_position=0,this.boxPosition=e.boxPosition,this.boxStyleMonitor=e.boxStyleMonitor,this.renderedAdTotal=0},{FOOTER_CSS_OBJECT:{"._popIn_about":{display:"none",position:"fixed",width:"100%",height:"100%",left:0,top:0,background:"rgba(0, 0, 0, 0.75)","z-index":9998},"._popIn_about.shown":{display:"block"},"._popIn_about_inner":{position:"absolute",width:"500px",height:"450px",left:"50%",top:"50%",margin:"-225px 0 0 -250px","background-color":"#fff","border-radius":"6px","z-index":9999},"._popIn_about_close_button":{position:"absolute",top:"-18px",left:"-18px",background:"url("+i.PROTOCOL+"//api.popin.cc/images/close.png) no-repeat",width:"36px",height:"36px",cursor:"pointer"},"._popIn_about_iframe":{width:"480px",height:"430px",border:"none",margin:"10px 0px 0px 10px"}},ABOUT_PAGE_TYPE_TARGET_MAP:{dialogue:"_blank",newTab:"_blank",sameTab:"_top"},execute:function(){var e=i.Common,t=e.CSSManager;return t.add(this.FOOTER_CSS_OBJECT),t.render(),new e.NodeBuilder(this._generateContainer(this.data)).build()},_generateContainer:function(e){this._generatedInfiniteAdCount=0;var t=this.title;return{tagName:"div",classList:"_popIn_recommend_container",property:{id:this.containerId||null},children:[t?{tagName:"header",classList:"_popIn_recommend_header",property:{textContent:t}}:void 0,{tagName:"div",classList:"_popIn_recommend_articles",children:this._generateInfinitePage(e)},{tagName:"footer",classList:"_popIn_recommend_footer",children:this._generateFooterParts(this.credit,this.aboutPageURL,this.aboutPageType)}]}},_generateInfinitePage:function(e){for(var t,i=this.infiniteSize,n=[],o=e.concat(),s=0;0<o.length;)t=o.splice(0,i),n.push({tagName:"ul",classList:"_popIn_infinite_page",children:this._generateList(t,i*s)}),s++;return n},_generateList:function(e,t){for(var i,n,o,s=[],a=0,r=e.length;a<r;a++)n=(i=e[a]).isAd,o=!1===this.isTargetTop&&(!0===n||!0===this.isTargetBlank),s.push({tagName:"li",children:[{tagName:"a",classList:["_popIn_recommend_article","_popIn_recommend_article_"+i.type,i.hasImage?"_popIn_recommend_has_img":"_popIn_recommend_no_img"],property:{href:i.url,target:!0==o?"_blank":"_top",rel:!0===n?"nofollow":null,dataset:{position:a+t+1,ad_position:!0===n?++this.ad_position:void 0},id:this._getTrackingPixelId(i)},children:this._generateArticleParts(i,a)}]}),!0===n&&this.renderedAdTotal++;return!0===this.hasInfiniteAds&&s.push({tagName:"li",classList:"_popIn_infinite_ad"}),s},_generateArticleParts:function(e){return[{tagName:"div",classList:"_popIn_recommend_art_img",children:this._generateImageInnerParts(e)},{tagName:"div",classList:"_popIn_recommend_art_title",property:{textContent:e.title}},e.category?{tagName:"div",classList:"_popIn_recommend_art_category",property:{textContent:e.category}}:void 0,e.pr?{tagName:"div",classList:"_popIn_recommend_art_media",property:{textContent:e.pr}}:void 0,e.formattedDate?{tagName:"div",classList:"_popIn_recommend_art_date",property:{textContent:e.formattedDate}}:void 0,e.authorName?{tagName:"div",classList:"_popIn_recommend_art_author",property:{textContent:e.authorName}}:void 0,e.comment?{tagName:"div",classList:"_popIn_recommend_art_comment",children:[{tagName:"span",classList:e.type+"_score",property:{textContent:e.score}}]}:void 0]},_generateFooterParts:function(e,t,i){return[{tagName:"a",classList:"_popIn_recommend_credit",property:{href:t,target:this.ABOUT_PAGE_TYPE_TARGET_MAP[i],textContent:e},children:[{tagName:"div",classList:"_popIn_recommend_credit_image"}]},"dialogue"===i?this._generateAboutMask():void 0]},_generateAboutMask:function(){return{tagName:"div",classList:"_popIn_about",property:{dataset:{action:"close"}},children:[{tagName:"div",classList:"_popIn_about_inner",children:[{tagName:"div",classList:"_popIn_about_close_button",property:{dataset:{action:"close"}}}]}]}},_getTrackingPixelId:function(e){return e.trackingPixelConf&&e.trackingPixelConf.trackingNodeId?e.trackingPixelConf.trackingNodeId:null},_generateImageInnerParts:function(e){var t=[],i={tagName:"div",classList:"_popIn_recommend_art_img_inner",property:{style:{backgroundImage:!0===this.imageInView?null:"url("+e.image+")"}}};return!e.dspObj||(e=e.dspObj.execDspFunc("setIcon"))&&t.push(e),t.push(i),t}})}(window.PopIn||{}),function(n){"use strict";var e=n.PROTOCOL,o=n.Discovery;n.createClass("Discovery.ArticleFormatter",function(e){e=e||{},this.originalData=e.originalData||[],this.apiHost=e.apiHost||"",this.target=e.target||"",this.imageSize=e.imageSize||"",this.displayUrlReplace=e.displayUrlReplace,this.logid=e.logid,this.notFoundImg=e.notFoundImg,this.channelId=e.channelId||"",this.addQuery=e.addQuery||"",this.mediaFormat=e.mediaFormat||"",this.dateFormat=e.dateFormat||"YYYY-MM-DD",this.smjId=e.smjId||"",this.referrer=e.referrer,this.tdClientId=e.tdClientId,this.userInfo=e.userInfo,this._popInFlagMap={},this.responseChannel=e.responseChannel||[],this.media=e.media||"",this.showInfoIcon=e.showInfoIcon||void 0,this.loc=e.loc},{IMAGE_PATH:e+"//imageaws.popin.cc/article/",AD_QUERY_MODE:"20170420",POPIN_FLAG_REGEX:/popIn\\_flag\\_/,execute:function(){var e=this.userInfo;return this._popInFlagMap={"${popIn_flag_media_host}":e.host,"${popIn_flag_os}":e.os,"${popIn_flag_timestamp}":+new Date},this.originalData.map(this._formatDatum.bind(this))},_formatDatum:function(e){var t=e.type,i=/^ad/.test(t),t={title:e.title,isAd:i,isReserved:/reserved/.test(t),originalUrl:e.originalUrl,pureUrl:e.url,type:t,comment:0===t.indexOf("comment")};return!0===i?this._editValuesForAd(t,e):this._editValuesForArticle(t,e)},_editValuesForArticle:function(e,t){e.url=this._formatUrl(t.url),e.image=this._selectImage(t)||this.notFoundImg,e.hasImage=""!==e.image&&e.image!==this.notFoundImg;var i=t.pubdate,n=i&&!1===/^0/.test(i);switch(e.pubdate=i,e.formattedDate=n?this._formatDate(i,this.dateFormat):"",e.category=t.category||"",e.authorName=t.author_name||"",e.score=t.score,e.imageHash=t.imageHash,e.originalTitle=t.originalTitle,e.type){case"pop":e.share=t.share;break;case"e_ranking":e.pv=t.pv;break;case"cf":e.recallRefer=Array.isArray(t.RecallRefer)?t.RecallRefer.join("|"):t.RecallRefer}return e},_editValuesForAd:function(e,t){e.url=this._replacePopInFlagInAdUrl(t.url),e.url=this._addQueryForAd(e.url),e.image=(t.image||t.image_url).replace(/i\.popincdn\.com/,"imageaws.popin.cc"),e.hasImage=""!==e.image,e.campaign=t.campaign,e.domain=t.domain,e.nid=t.nid,e.c1=t.c1,e.c2=t.c2,e.media=t.media,e.pr=e.media?this.mediaFormat.replace(/\$MEDIA/,e.media):void 0,e.userid=t.userid,e.businessType=t.business_type,e.vFruitWord=t.v_fruit_word,e.imageHash=t.image_hash,e.sample=t.sample,e.clarity=t.originalDatum,e.classify=t.classify,e.aesthetic=t.aesthetic,this._setTrackingPixelConfig(e,t);var i=n.Common.Utils.parseUrl(e.url);return e.token=i.qString.token,e.uid=i.qString.uid,e.dsp=t.dsp||void 0,e.nurl=t.nurl||void 0,e.privacy=t.privacy||void 0,e.imptrackers=t.imptrackers||void 0,e.clicktrackers=t.clicktrackers||void 0,t.imp&&(e.originalImp=t.imp,e.imp=this._addQueryForAd(t.imp)),!e.dsp||(t=new o.Dsp(t.dsp)).setup(e,{addParameters:this._addQueryForAd("").replace(/^(\?|&)/,""),media:this.media,channelId:this.channelId,showInfoIcon:this.showInfoIcon})&&(e.dspObj=t),e},_replacePopInFlagInAdUrl:function(e){var i;return 1==this.POPIN_FLAG_REGEX.test(e)&&(i=this._popInFlagMap,e=e.replace(/\blp=.+?&/,function(e){for(var t in i)e=e.replace(new RegExp(encodeURIComponent(t),"g"),i[t]);return e})),e},_selectImage:function(e){var t=e.image,i=!t,n=this.imageSize;return!0==i?"":"original"===n?e.image_url:this._formatImageUrl(t,n)},_formatDate:function(e,t){var i=Number(e.substr(0,4)),n=Number(e.substr(4,2)),o=Number(e.substr(6,2)),s=Number(e.substr(8,2)),a=Number(e.substr(10,2)),e=Number(e.substr(12,2));return t.replace(/YYYY/g,i).replace(/YY/g,(""+i).slice(-2)).replace(/MM/g,("0"+n).slice(-2)).replace(/DD/g,("0"+o).slice(-2)).replace(/hh/g,("0"+s).slice(-2)).replace(/mm/g,("0"+a).slice(-2)).replace(/ss/g,("0"+e).slice(-2)).replace(/M/g,n).replace(/D/g,o).replace(/h/g,s).replace(/m/g,a).replace(/s/g,e)},_formatUrl:function(e){return(this.displayUrlReplace?n.Common.Utils.replaceAll(e,this.displayUrlReplace):e)+(this.addQuery?this._getDelimiter(e)+this.addQuery:"")},_getDelimiter:function(e){return!0===/\?/.test(e)?"&":"?"},_addQueryForAd:function(e){var t=n.Common.Utils.convertObjectToParameterString({api_host:this.apiHost,mode:this.AD_QUERY_MODE,referer_type:this.referrer,td_client_id:this.tdClientId||void 0,extra:this._getClickExtraStr(),logid:this.logid||void 0,smjid:this.smjid||void 0,piuid:n.Common.Uid.getUid()}),i="&uid="+n.Common.Uid.getUid();return-1!==e.indexOf("&uid=")?e=e.replace(/&uid=[^&]*/,i):t+=i,e+this._getDelimiter(e)+t},_formatImageUrl:function(e,t){return this.IMAGE_PATH+(""===t?e:e.replace(/\./,"_"+t+"."))},_getChannelId:function(){var e=[];return void 0!==this.channelId&&this.channelId&&e.push("m_ch_"+this.channelId),0<this.responseChannel.length&&e.push.apply(e,this.responseChannel.map(function(e){return"m_"+e})),0<e.length?e.join("%7C"):void 0},_getClickExtraStr:function(){var e=[];return e.push(this._getChannelId()),e.push(this.loc?"c_lc_"+this.loc:""),e.filter(function(e){return!!e}).join("%7C")||void 0},_setTrackingPixelConfig:function(e,t){e.trackingPixel=this._formatTrackingPixelMacroCode(t.tracking_pixel,t),e.clickTrackingPixel=this._formatTrackingPixelMacroCode(t.click_tracking_pixel,t);var i=e.trackingPixel?this._getCustomTrackingPixelConf(e.trackingPixel):null;i&&"ias"===i.name&&(t=e.campaign+e.nid+(new Date).getTime(),t=btoa(n.Common.Utils.digest(t)),e.trackingPixelConf={},e.trackingPixelConf.name=i.name,e.trackingPixelConf.trackTiming=i.tracking_timing,e.trackingPixelConf.trackingNodeId=t,e.trackingPixel=e.trackingPixel.replace(/(https?:)?\/\/\w+\.adsafeprotected.com\/(?!.*ias_adpath.*)([\w-./?%&=]*)?/g,"$&&ias_adpath=%23"+t))},_formatTrackingPixelMacroCode:function(e,t){if(e){var i,n=e,o={"{{p_advid}}":t.userid,"{{p_campId}}":t.campaign,"{{p_sid}}":this.media,"{{p_adid}}":t.nid};for(i in o)var s=new RegExp(i,"g"),a=o[i],n=n.replace(s,a);return n}},_getCustomTrackingPixelConf:function(e){for(var t,i=[{name:"ias",check_reg:/https?:\/\/\w+.adsafeprotected.com\//,tracking_timing:"afterRender"}],n=0,o=i.length;n<o;n++)if((t=i[n]).check_reg&&t.check_reg.test(e))return t}})}(window.PopIn||{}),function(l){"use strict";var e=l.PROTOCOL,c=l.Discovery;l.inherit("Discovery.ArticleList","Common.Publisher",function(e){e=e||{},this.commonUseCfRatio=e.commonUseCfRatio,this.commonChannelPrefix=e.commonChannelPrefix,this.apiHost=e.apiHost||"",this.referrer=e.referrer||"",this.popInUserId=l.Common.Uid.getUid(),this.originalData=e.originalData||{},this.media=e.media||"",this.template=e.template||{},this.targetUrl=e.targetUrl||"",this.logid=e.logid,this.targetNode=e.targetNode,this.hasInfiniteAds=e.hasInfiniteAds||!1,this.adInView=e.adInView||!1,this.aboutPageType=e.aboutPageType,this.infiniteAdSerialiseEnable=e.infiniteAdSerialiseEnable||!1,this.tdClientId=e.tdClientId,this.country=e.country,this.userInfo=e.userInfo,this.brandSafety=e.brandSafety||{},this.boxPosition=e.boxPosition,this.boxStyleMonitor=e.boxStyleMonitor,this.loc=e.loc,this.data=[],this.node,this._hasAboutIframe=!1},{CLASS_NAME_FOOTER_SHOWN:"shown",DEFAULT_NOT_FOUND_IMAGE_URL:e+"//api.popin.cc/images/noimg.png",ABOUT_PAGE_URL:e+"//www.popin.cc/discovery/what-is.php",DEFAULT_ARTICLE_NO_DISPLAY_PERIOD:7,setup:function(){var e=this.template,t=this.originalData,i=this._selectData(t,e),n=this.hasInfiniteAds;if(i.length<e.infiniteSize)return!1;for(var o=!1,s=0,a=i.length;s<a;s++){if("cf"==i[s].type&&(o=!0),o)break}var r=e.cfChannelPrefix||this.commonChannelPrefix||"",d=!!e.channelId&&e.channelId;d&&/^(?!with_sz_)/.test(d)&&o&&(d=r+d),this.channelId=d,e.channelId=d;d=this._formatData(i,e),e=this._generateNode(d,e,n);return this.data=d,this.node=e,l.Common.Global.expectedAndRenderAds[this.channelId]={expectedAdTotal:this.expectedAdTotal,renderedAdTotal:this.renderedAdTotal},this.trigger("beforeRender",e,d,this),this.targetNode.appendChild(e),!0===n&&this._generateInfiniteAds(e,t.infinite,this.adInView,this.infiniteAdSerialiseEnable),this._registerCustomTimingTrackingPixels(d),this._registerEvents(e),this.trigger("afterRender",e,d,this),this.brandSafety.process(e,{apihost:this.apiHost,logid:this.logid,media:this.media}),l.Common.NodeObserver.start(),!0},_selectData:function(e,t){e=new c.ArticleSelector({template:t,originalData:e,type:t.type,targetUrl:this.targetUrl,isRandom:t.isRandom||!1,includeRules:t.includeRules||[],excludeRules:t.excludeRules||[],delImage:t.delImage,delWord:t.delWord,canShowSameAds:t.canShowSameAds||!1,allowDuplication:t.forceProcess||!1,infinitePages:t.infinitePages,infiniteSize:t.infiniteSize,isClickHistory:!1!==t.isClickHistory,hideHistory:t.hideHistory||!1,articleNoDisplayPeriod:t.articleNoDisplayPeriod||this.DEFAULT_ARTICLE_NO_DISPLAY_PERIOD,showLocation:t.showLocation||!1,commonUseCfRatio:this.commonUseCfRatio}),t=e.execute();return this.expectedAdTotal=e._expectedAdTotal,t},_formatData:function(e,t){return new c.ArticleFormatter({popInUserId:this.popInUserId,originalData:e,apiHost:this.apiHost,tdClientId:this.tdClientId,logid:this.logid,referrer:this.referrer,mediaFormat:t.mediaFormat,imageSize:t.imageSize||"",displayUrlReplace:t.displayUrlReplace,notFoundImg:t.notFoundImg||this.DEFAULT_NOT_FOUND_IMAGE_URL,channelId:t.channelId||"",addQuery:t.addQuery||"",dateFormat:t.dateFormat||"",userInfo:this.userInfo,responseChannel:void 0!==this.originalData.channel?this.originalData.channel:[],media:this.media,showInfoIcon:t.showInfoIcon,loc:this.loc}).execute()},_generateNode:function(e,t,i){i=new c.ArticleBuilder({data:e,containerId:t.containerId,infinitePages:t.infinitePages,infiniteSize:t.infiniteSize,isTargetBlank:t.addTargetBlank,isTargetTop:t.isTargetTop,hasInfiniteAds:i,imageInView:t.imageInView,title:t.title,credit:t.credit,aboutPageType:this.aboutPageType,aboutPageURL:this.ABOUT_PAGE_URL,boxPosition:this.boxPosition,boxStyleMonitor:this.boxStyleMonitor}),t=i.execute();return this.renderedAdTotal=i.renderedAdTotal,t},_generateInfiniteAds:function(e,t,i,n){new c.InfiniteAd({data:t,containerNode:e,adInView:i,serialiseEnable:n}).setup()},_registerEvents:function(e){var t,i;"dialogue"===this.aboutPageType&&(t=e.querySelector("._popIn_recommend_credit"),i=e.querySelector("._popIn_about"),t.addEventListener("click",this._showAbout.bind(this,i)),i.addEventListener("click",this._closeAbout.bind(this))),l.Common.NodeObserver.addTarget({node:e,onInView:this._onInView.bind(this)}),this._registerArticleLinkEvents(Array.apply(null,e.getElementsByClassName("_popIn_recommend_article")),this.data),this._stopPropagationDspIconClick(Array.apply(null,e.getElementsByClassName("_popIn_recommend_article_ad_info_icon_inner")))},_showAbout:function(e,t){var i;l.Common.Utils.killEvent(t),!1===this._hasAboutIframe&&(i=e.querySelector("._popIn_about_inner"),t=new l.Common.NodeBuilder({tagName:"iframe",classList:"_popIn_about_iframe",property:{frameBorder:0,scrolling:"no",src:this.ABOUT_PAGE_URL}}),i.appendChild(t.build()),this._hasAboutIframe=!0),e.classList.add(this.CLASS_NAME_FOOTER_SHOWN)},_closeAbout:function(e){"close"===e.target.dataset.action&&e.currentTarget.classList.remove(this.CLASS_NAME_FOOTER_SHOWN)},_registerArticleLinkEvents:function(e,t){for(var i,n,o=this.template.imageInView,s=l.Common.NodeObserver,a=0,r=e.length;a<r;a++){i=e[a],(n=t[a]).element=i;var d=new c.ArticleStyleMonitor(i);n.articleStyleMonitor=d,"1"===i.dataset.ad_position&&(this.positionAndStyle=new c.PositionAndStyle({channelId:this.channelId,boxPosition:this.boxPosition,articleStyleMonitor:d})),l.Common.Utils.setPopInDomData(i,Object.assign({},n)),i.addEventListener("click",this._onClick.bind(this,n),!1),s.addTarget({node:i,onInView:this._onImp.bind(this,n,o)})}i=null},_onClick:function(e,t){l.Common.Utils.killEvent(t),this.trigger("click",t.currentTarget,e,this)},_onInView:function(e){this.trigger("inView",e,this.data,this)},_onImp:function(e,t,i){!0===t&&(t=i.querySelector("._popIn_recommend_art_img_inner"),this._renderImg(t,e.image,e)),this.trigger("imp",i,e,this)},_renderImg:function(e,t,i){var n=new Image,o=+new Date,s=this;n.onload=function(){e.style.backgroundImage="url("+t+")",s.trigger("afterImgLoad",e,{start:o,end:+new Date,channelId:s.channelId,media:s.media,logid:s.logid,data:i},s),n=null},n.onerror=function(){},n.src=t},_registerCustomTimingTrackingPixels:function(e){for(var t,i,n=l.Common.Utils,o=0,s=e.length;o<s;o++)t=e[o],(i=this._getCustomTrackingPixelTiming(t))&&(function(e,t){e.on(i,function(){n.writeCodeInIframe(t)})}(this,t.trackingPixel),t.trackingPixel=void 0)},_getCustomTrackingPixelTiming:function(e){if(e.trackingPixel)return e.trackingPixelConf&&e.trackingPixelConf.trackTiming?e.trackingPixelConf.trackTiming:void 0},_stopPropagationDspIconClick:function(e){for(var t=0,i=e.length;t<i;t++)e[t].addEventListener("click",function(e){e.stopPropagation()},!1)}})}(window.PopIn||{}),function(f){"use strict";f.createClass("Discovery.ArticleSelector",function(e){e=e||{},this.template=e.template,this.commonUseCfRatio=e.commonUseCfRatio,this.useCf=!1,this.type=e.type,this.originalData=e.originalData||{},this.targetUrl=e.targetUrl||"",this.infinitePages=e.infinitePages||0,this.infiniteSize=e.infiniteSize||0,this.isRandom=e.isRandom||!1,this.delImage=e.delImage||void 0,this.delWord=e.delWord,this.allowDuplication=e.allowDuplication||!1,this.includeRules=e.includeRules||[],this.excludeRules=e.excludeRules||[],this.isClickHistory=e.isClickHistory||!1,this.canShowSameAds=e.canShowSameAds||!1,this.hideHistory=e.hideHistory||!1,this.articleNoDisplayPeriod=e.articleNoDisplayPeriod||0,this.showLocation=e.showLocation||!1,this.maxArticleCount=0,this.selectedArticlesInWidget=[],this.data=[],this.delWordRegExp,this._articleClickHistories=[],this._articleExpiredTime=0;e=this.constructor;void 0===e._selectedArticlesInDiscovery&&(e._selectedArticlesInDiscovery=[])},{MAX_ELAPSED_DAYS_FROM_LAST_AD_CLICK:30,MAX_AD_DISPLAY_COUNT:3,TYPE_METHOD_NAME_MAP:{pattern:"_generatePatterns",left:"_selectByAsc",right:"_selectByDesc",rand:"_selectAtRandom"},_expectedAdTotal:0,execute:function(){var e=this.delWord;"string"==typeof e&&0<e.length&&(this.delWordRegExp=new RegExp(e,"g")),"function"==typeof this.excludeRules&&(this.excludeRules=[this.excludeRules]),"function"==typeof this.includeRules&&(this.includeRules=[this.includeRules]),!0===this.isClickHistory&&this._addClickHistoryCheckRule(this.originalData.cookie),!0===this.hideHistory&&(n=f.Common.Storage.get("local",f.Discovery.RecommendModule.prototype.ARTICLE_CLICK_HISTORY_LOCAL_STORAGE_KEY),this._articleClickHistories=null===n?[]:JSON.parse(n),this._articleExpiredTime=Date.now()-864e5*this.articleNoDisplayPeriod,this.excludeRules.push(this._canShowArticle.bind(this)));var t=this.infiniteSize,i=t*this.infinitePages;if(i<=0)return!1;this.maxArticleCount=i,this._isCfRatio();var e=this._process(this.type),n=Math.floor(e.length/t),t=Math.min(i,n*t),t=e.slice(0,t);return Array.prototype.push.apply(this.constructor._selectedArticlesInDiscovery,t.map(function(e){return{originalUrl:e.originalUrl,title:e.title}})),this.data=t},_isCfRatio:function(){var e=this.template.useCfRatio||this.commonUseCfRatio;if(e){var t=f.Common.Storage.get("session","_pi_cf_abtest_key_"+this.template.channelId);if(t?this.useCf="with_cf"===t:Math.random()<=e?(f.Common.Storage.set("session","_pi_cf_abtest_key_"+this.template.channelId,"with_cf"),this.useCf=!0):f.Common.Storage.set("session","_pi_cf_abtest_key_"+this.template.channelId,"without_cf"),this.useCf){for(var i=this.type,n=!1,o=0,s=i.length;o<s;o++){var a=i[o],r="string"==typeof a?"+"+a+"+":"";if(Array.isArray(a)&&(r="+"+a.join("+")+"+"),/\+cf\+/.test(r)){n=!0;break}}n||this.type.splice(1,0,["left","cf",50])}}},_canShowArticle:function(e){return!0===/^ad/.test(e.type)||this._articleClickHistories.every(this._isValidPeriodArticle.bind(this,e.url,this._articleExpiredTime))},_isValidPeriodArticle:function(e,t,i){return!1===this._isInvalidPeriodArticle(e,t,i)},_isInvalidPeriodArticle:function(e,t,i){return i.url===e&&i.timestamp>=t},_deleteDuplicates:function(e){for(var t,i,n=[],o=this.constructor._selectedArticlesInDiscovery,s=0,a=e.length;s<a;s++)t=e[s],!(i={originalUrl:t.originalUrl,title:t.title})===o.some(function(e){return e.originalUrl===i.originalUrl||e.title===i.title})&&n.push(t);return n},_formatArticle:function(e,t){var i=e.url,n=e.origin_url||i,o=e.title,s=e.image;if(void 0===e.title||!1===this.showLocation&&n===this.targetUrl)return!1;var a=this._deleteWords(this._decodeTitle(e.title));if(""===a)return!1;i=Object.assign({},e);i.title=a;a=e.image,e="string"==typeof a&&0<a.length&&"noimage"!==a&&!1===this._isDelImage(a);return i.originalUrl=n,i.image=!0==e?a:"",i.type=t,i.type2=t+(!0==e?"_img":"_noimg"),i.originalTitle=o,i.imageHash=s,!1!==this._isValid(i)&&i},_isDelImage:function(e){return"string"==typeof this.delImage&&0<=e.indexOf(this.delImage)},_decodeTitle:function(e){return(e=e||"").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"').replace(/&#39;/g,"'").replace(/&amp;/g,"&")},_deleteWords:function(e){return e=e||"",void 0===this.delWordRegExp?e:e.replace(this.delWordRegExp,"")},_isValid:function(e){return!1!==this.excludeRules.every(this._isPassed.bind(this,e))&&(this.includeRules.some(this._isPassed.bind(this,e)),!0)},_isPassed:function(e,t){return!0===t(e)},_getArticlesByType:function(e){for(var t,i=this.originalData[e]||[],n=[],o=0,s=i.length;o<s;o++)!1!==(t=this._formatArticle(i[o],e))&&n.push(t);return n},_process:function(e,t){var i=[];return"string"==typeof e?(i=this._getArticlesByType(e),"number"==typeof t&&"ad"===e&&!0===this.canShowSameAds&&(i=this._copyDataWithLength(i,t))):!0!==Array.isArray(e)||"function"==typeof(t=this[this.TYPE_METHOD_NAME_MAP[e[0]]])&&(i=t.call(this,e)),!0===this.allowDuplication?this._deleteDuplicatesDsp(i):this._deleteDuplicates(i)},_copyDataWithLength:function(e,t){if(0===e.length)return e;var i=e.concat(),n=e.filter(function(e){return!e.dsp}),o=0,s=n.length;if(0===s)return e;for(;i.length<t;)i.push(n[o%s]),o++;return i},_getMiddle:function(e){for(var t=[],i=e.length-1,n=e[i],o=1;o<i;o++)Array.prototype.push.apply(t,this._process(e[o],n));return t},_selectAtRandom:function(e){var t=e[e.length-1],e=f.Common.Utils.shuffle(this._getMiddle(e));return e.slice(0,Math.min(t,e.length))},_selectByAsc:function(e){var t=e[e.length-1],e=this._getMiddle(e);return e.slice(0,Math.min(t,e.length))},_selectByDesc:function(e){var t=e[e.length-1],e=this._getMiddle(e);return e.slice(Math.max(0,e.length-t),e.length).reverse()},_generatePatterns:function(e){var t,i,n=e[e.length-1],o=this._getMiddle(e).concat(),s=this.isRandom,a=this.maxArticleCount,r=f.Common.Utils,d=[];do{for(i=n;"function"==typeof i;)i=i();if(0<i.length&&this.useCf)for(var l=0,c=i.length;l<c;l++){var h=i[l];Array.isArray(h)?"ad"===h[0]||/^ad_/.test(h[0])?i[l].splice(1,0,"cf_img"):"cf_img"!=h[0]&&i[l].splice(0,0,"cf_img"):"ad"===h||/^ad_/.test(h)?i.splice(l,1,[h,"cf_img"]):"cf_img"!=h&&i.splice(l,1,["cf_img",h])}t=this._generatePatternPer1Page(!0===s?r.shuffle(i):i,o),Array.prototype.push.apply(d,t)}while(0<t.length&&d.length<a);return d},_generatePatternPer1Page:function(e,t){for(var i,n,o,s,a=this.selectedArticlesInWidget,r=[],d=(f.Common.Utils,this.canShowSameAds),l=this.template.infiniteSize*this.template.infinitePages,c=0,h=0,p=e.length;h<p;h++){i=e[h];e:for(var _=0,m=(i=Array.isArray(i)?i:[i]).length;_<m;_++){n=i[_],0===_&&c<l&&("ad"===n||"ad_imp"===n)&&this._expectedAdTotal++;for(var g=0,u=t.length;g<u;g++)if(o=t[g],s={originalUrl:o.originalUrl,title:o.title},-1<o.type2.indexOf(n)&&("ad"===n&&!0===d||!1===a.some(function(e){return e.originalUrl===s.originalUrl||e.title===s.title}))){r.push(o),t.splice(g,1),a.push({originalUrl:s.originalUrl,title:s.title}),c++;break e}}}return r},_addClickHistoryCheckRule:function(e){e=e._click;if(e){for(var t,i,n={},o=e.split("|"),s=Date.now(),a=0,r=o.length;a<r;a++)i=(t=o[a].split("."))[1],(s-t[2])/864e5>this.MAX_ELAPSED_DAYS_FROM_LAST_AD_CLICK||(void 0===n[i]&&(n[i]=0),n[i]++);this.excludeRules.push(this._shouldExcludeClickedAd.bind(this,n))}},_shouldExcludeClickedAd:function(e,t){if(-1<t.type.indexOf("ad")&!t.dsp&e[t.nid]&&e[t.nid]>=this.MAX_AD_DISPLAY_COUNT)return!1;return!0},_deleteDuplicatesDsp:function(e){for(var t,i,n=[],o=this.constructor._selectedArticlesInDiscovery,s=0,a=e.length;s<a;s++)"ad"===(t=e[s]).type&&t.dsp&&(i={originalUrl:t.originalUrl,title:t.title},!0===o.some(function(e){return e.originalUrl===i.originalUrl||e.title===i.title}))||n.push(t);return n}})}(window.PopIn||{}),function(){"use strict";(window.PopIn||{}).createClass("Discovery.ArticleStyleMonitor",function(e){this.articleNode=e||{},this.styleFlag=""},{styleFlagEnum:{UNKNOW:"0",ERROR:"_",STYLE_1:"1",STYLE_2:"2",STYLE_3:"3",STYLE_4:"4",STYLE_5:"5",STYLE_6:"6"},checkList:["checkStyle1","checkStyle2","checkStyle3","checkStyle4","checkStyle5","checkStyle6"],initAttribute:function(){this.articleRect=this.articleNode.getBoundingClientRect(),this.parentNode=this.articleNode.parentNode,this.parentRect=this.parentNode.getBoundingClientRect(),this.imageNode=this.articleNode.querySelector("._popIn_recommend_art_img"),this.imageRect=this.imageNode.getBoundingClientRect();var e=this.articleNode.querySelector("._popIn_recommend_art_title");this.titleNode=e.children[0]||e,this.titleRect=this.titleNode.getBoundingClientRect()},getStyleFlag:function(){try{if(this.styleFlag)return this.styleFlag;var e;this.initAttribute();for(var t,i=0;t=this.checkList[i++];)if("function"==typeof this[t]&&(e=this[t]()))return this.styleFlag=e}catch(e){return this.styleFlag=this.styleFlagEnum.ERROR}return this.styleFlag=this.styleFlagEnum.UNKNOW},checkStyle1:function(){if(0===this.imageRect.width&&0===this.imageRect.height)return this.styleFlagEnum.STYLE_1},checkStyle2:function(){if(this.titleRect.top>=this.imageRect.bottom&&.9<=this.articleRect.width/this.parentRect.width)return this.styleFlagEnum.STYLE_2},checkStyle3:function(){if(this.titleRect.top>=this.imageRect.bottom)return this.styleFlagEnum.STYLE_3},checkStyle4:function(){if(this.imageRect.right<=this.titleRect.left)return this.styleFlagEnum.STYLE_4},checkStyle5:function(){if(this.titleRect.right<=this.imageRect.left)return this.styleFlagEnum.STYLE_5},checkStyle6:function(){if(this.titleRect.top>this.imageRect.top&&this.titleRect.right>this.imageRect.left&&this.titleRect.bottom<=this.imageRect.bottom&&this.titleRect.left<this.imageRect.right)return this.styleFlagEnum.STYLE_6}})}(),function(){"use strict";(window.PopIn||{}).createClass("Discovery.BoxPosition",function(e){e=e||{},this.device=e.device,this.box=e.box,this.position=""},{getPosition:function(){return this.position||(window.self!==window.top?this.position="iframe":this.position="mobile"===this.device?this.getPositionInMobile():this.getPositionInPc()),this.position},getElementAbPosition:function(e){for(var t=e.offsetLeft,i=e.offsetTop;e=e.offsetParent;)t+=e.offsetLeft,i+=e.offsetTop;return{left:t,top:i}},getPositionInMobile:function(){var e=this.box.getBoundingClientRect(),t=this.getElementAbPosition(this.box).top+e.height/2,e=document.documentElement.scrollHeight;return e&&t?t<e/3?"top":t<e/3*2?"middle":"bottom":"unknow"},getPositionInPc:function(){var e=this.box.getBoundingClientRect(),t=this.getElementAbPosition(this.box),i=t.top+e.height/2,n=t.left+e.width/2,t=document.documentElement.scrollHeight,e=document.documentElement.scrollWidth;return t&&e&&i?[i<t/2?"top":"bottom",n<e/2?"left":"right"].join("_"):"unknow"}})}(),function(s){"use strict";s.createClass("Discovery.BoxStyleMonitor",["Common.Utils"],function(e){this.boxNode=e,this.styleFlag=""},{getStyleFlag:function(){if(this.styleFlag)return this.styleFlag;for(var e=s.Common.Utils,t=this.boxNode.querySelectorAll("._popIn_infinite_page:first-child ._popIn_recommend_article"),i="",n=0;o=t[n];n++){var o=e.getPopInDomData(o,"articleStyleMonitor");o?i+=o.getStyleFlag():i+="_"}return this.styleFlag=i},getPopInDomData:function(e,t){if(!e)return{};e=+e[_POPIN_DOM_DATA_KEY];if("number"!=typeof e||NaN===e)return null;e=_popInDomDataList[e]||null;return"string"==typeof t?e[t]:e}})}(window.PopIn||{}),function(){"use strict";(window.PopIn||{}).createClass("Discovery.BrandSafety",function(){this.impIdArry=[]},{process:function(e,t){if(!(t=t||{}).logid)return!1;this.logid=t.logid||"",this.media=t.media||location.host,this.apiHost=t.apihost||"jp.popiin.cc",this.impIdArry[this.logid]=void 0!==this.impIdArry[this.logid]?this.impIdArry[this.logid]+1:1,this._momentumTagRender(e)},_momentumTagRender:function(e){var t,i,n,o,s;"jp.popin.cc"===this.apiHost&&(t="UUID_DIV",i=this.logid,n=this.impIdArry[this.logid],o=this.media,(s=document.createElement("script")).src="//assets-momentum.akamaized.net/js/axss.js",e.classList.add(t),e=function(){momentum_heron.set_postbid_observer(t,38,i,String(n),o,{dest:"http://jp.popin.cc/popin_discovery/pbc",payload:{ext:{momentum:{heron:{require:[1,2,4]}}}}})},void 0!==s.onload?s.onload=e:s.readyState&&(s.onreadystatechange=e),document.body.appendChild(s))}})}(),function(t){"use strict";t.createClass("Discovery.DspFluct",function(){},{setup:function(e,t){this.item=e||{},this.parameters=t||""},_sendImgRequest:function(e){(new Image).src=e},_imp:function(e){this.item.nurl&&this._sendImgRequest(this.item.nurl),Array.isArray(this.item.imptrackers)&&this.item.imptrackers.forEach(function(e){this._sendImgRequest(e)},this)},_click:function(){Array.isArray(this.item.clicktrackers)&&this.item.clicktrackers.forEach(function(e){this._sendImgRequest(e)},this)},_setIcon:function(e){var t=this.item.privacy||"",i=void 0===this.parameters.showInfoIcon?t:this.parameters.showInfoIcon;return!!i&&(t={tagName:"div",classList:"_popIn_recommend_article_ad_info_icon",property:{style:{backgroundImage:"url(//api.popin.cc/images/info-icon.png)"}},children:[{tagName:"a",classList:"_popIn_recommend_article_ad_info_icon_inner",property:{href:t,target:"_blank"}}]},this._addDspIconCss(),t)},_addDspIconCss:function(){var e=t.Common.CSSManager;e.add({"._popIn_recommend_article_ad_info_icon":{position:"absolute",width:"3vw",height:"3vw","max-width":"15px","max-height":"15px","background-repeat":"no-repeat","background-size":"contain","background-position":"center","background-color":"#fff","z-index":1},"._popIn_recommend_article_ad_info_icon > ._popIn_recommend_article_ad_info_icon_inner":{position:"relative",width:"100%",height:"100%",padding:"0",display:"block",opacity:"1"}}),e.render()},_cookieSync:function(){}})}(window.PopIn||{}),function(t){"use strict";t.createClass("Discovery.DspLogicad",function(){},{setup:function(e,t){this.item=e||{},this.parameters=t||""},_sendImgRequest:function(e){(new Image).src=e},_imp:function(e){this.item.nurl&&this._sendImgRequest(this.item.nurl),Array.isArray(this.item.imptrackers)&&this.item.imptrackers.forEach(function(e){this._sendImgRequest(e)},this)},_click:function(){Array.isArray(this.item.clicktrackers)&&this.item.clicktrackers.forEach(function(e){this._sendImgRequest(e)},this)},_setIcon:function(e){var t=this.item.privacy||"//www.popin.cc/home/privacy.html",i=void 0===this.parameters.showInfoIcon?-1<this.parameters.media.indexOf("infeed")||-1<this.parameters.channelId.indexOf("infeed"):this.parameters.showInfoIcon;return!!i&&(t={tagName:"div",classList:"_popIn_recommend_article_ad_info_icon",property:{style:{backgroundImage:"url(//api.popin.cc/images/info-icon.png)"}},children:[{tagName:"a",classList:"_popIn_recommend_article_ad_info_icon_inner",property:{href:t,target:"_blank"}}]},this._addDspIconCss(),t)},_addDspIconCss:function(){var e=t.Common.CSSManager;e.add({"._popIn_recommend_article_ad_info_icon":{position:"absolute",width:"3vw",height:"3vw","max-width":"15px","max-height":"15px","background-repeat":"no-repeat","background-size":"contain","background-position":"center","background-color":"#fff","z-index":1},"._popIn_recommend_article_ad_info_icon > ._popIn_recommend_article_ad_info_icon_inner":{position:"relative",width:"100%",height:"100%",padding:"0",display:"block",opacity:"1"}}),e.render()},_cookieSync:function(){var t;function e(e){return-1!=t.indexOf(e)}t=window.navigator.userAgent.toLowerCase(),e("iphone")||e("ipod")||e("ipad")||window.navigator.vendor&&-1!=window.navigator.vendor.toLowerCase().indexOf("apple")||((new Image).src="https://cr-p34.ladsp.jp/cookiesender/34")}})}(window.PopIn||{}),function(n){"use strict";n.createClass("Discovery.Dsp",function(e){this._dspName=e||"",this._dspObj={}},{setup:function(e,t){var i="Dsp"+this._dspName.charAt(0).toUpperCase()+this._dspName.slice(1);return!!n.Discovery[i]&&(this._dspObj=new n.Discovery[i],this._dspObj.setup(e,t),!0)},execDspFunc:function(e,t){e="_"+e;if(this._dspObj[e])return this._dspObj[e](t)},default_setIcon:function(e){var t=document.createElement("div"),i=document.createElement("a");t.className="_popIn_recommend_article_ad_info_icon",t.style.backgroundImage="url(//api.popin.cc/images/info-icon.png)",i.className="_popIn_recommend_article_ad_info_icon_inner",i.href="//www.popin.cc/home/privacy.html",i.target="_blank",t.appendChild(i),e.appendChild(t),this._addDspIconCss()},_addDspIconCss:function(){var e=n.Common.CSSManager;e.add({"._popIn_recommend_article_ad_info_icon":{position:"absolute",width:"3vw",height:"3vw","background-repeat":"no-repeat","background-size":"contain","background-position":"center"},"._popIn_recommend_article_ad_info_icon > ._popIn_recommend_article_ad_info_icon_inner":{position:"relative",width:"100%",height:"100%",padding:"0",display:"block",opacity:"1"}}),e.render()}})}(window.PopIn||{}),function(a){"use strict";a.createClass("Discovery.InfiniteAd",function(e){e=e||{},this.data=e.data||[],this.containerNode=e.containerNode,this.adInView=e.adInView||!1,this.serialiseEnable=e.serialiseEnable||!1;e=this.constructor;void 0===e.lastIndex&&(e.lastIndex=0)},{setup:function(){var e=Array.apply(null,this.containerNode.getElementsByClassName("_popIn_infinite_ad"));this._renderAds(e,this.data),a.Common.NodeObserver.start()},_renderAds:function(e,t){for(var i,n,o=this.constructor,s=!0===this.serialiseEnable?o.lastIndex:0,a=t.length,r=0,d=e.length;r<d;r++)i=e[r],(n=t[s%a])&&"ad"===n.type&&this._renderAd(i,n),s++;o.lastIndex=s},_renderAd:function(e,t){var i=a.Common,n=i.Utils,o=t.height+"px",s=n.createIFrameObject("about:blank",{width:t.width+"px",height:o,margin:"0px auto"}),t=n.createIframeBodyOuterHTML(t.script);e.style.height=o,e.appendChild(s.element),!0===this.adInView?i.NodeObserver.addTarget({node:e,onInView:this._writeBodyInIframe.bind(null,s,t)}):this._writeBodyInIframe(s,t)},_writeBodyInIframe:function(e,t){e.write(t)}})}(window.PopIn||{}),function(n){"use strict";var o="_popIn_box_position_style_key_";n.createClass("Discovery.PositionAndStyle",["Common.Utils"],function(e){this.positionAndStyleObj=e||{},this.channelId=this.positionAndStyleObj.channelId,this.boxPosition=this.positionAndStyleObj.boxPosition||{},this.articleStyleMonitor=this.positionAndStyleObj.articleStyleMonitor||{},this.position="",this.styleMonitor="",this.timer=null,this.timerTimes=0,this.intervalPositionAndStyle()},{intervalPositionAndStyle:function(){this.timer=setTimeout(this.setPositionAndStyle.bind(this),500)},setPositionAndStyle:function(){this.timerTimes++;var e,t=[],i=n.Common.Storage;this.position=this.boxPosition.getPosition(),this.styleMonitor=this.articleStyleMonitor.getStyleFlag(),this.position&&this.styleMonitor?(window.popInPositionAndStyle?(e=i.get("local",o)||"[]",(e=JSON.parse(e)).push({channelId:this.channelId,boxPosition:this.position,adStyleMonitor:this.styleMonitor}),t=e):(t=[{channelId:this.channelId,boxPosition:this.position,adStyleMonitor:this.styleMonitor}],window.popInPositionAndStyle=!0),i.set("local",o,JSON.stringify(t)),clearTimeout(this.timer)):this.timerTimes<10?this.intervalPositionAndStyle():clearTimeout(this.timer)}})}(window.PopIn||{}),function(I,r,d){"use strict";I.inherit("Discovery.RecommendModule",I.Discovery.Module,function(e){e=e||{},this.commonUseCfRatio=e.commonUseCfRatio,this.commonChannelPrefix=e.commonChannelPrefix,this.pid=e.pid,this.adEnable=e.adEnable||!1,this.ad=e.ad,this.adInView=e.adInView||!1,this.referrer=e.referrer||"",this.targetNode=e.targetNode,this.template=e.template||{},this.userInfo=e.userInfo,this.originalData=e.originalData||{},this.boxPosition=new I.Discovery.BoxPosition({box:this.targetNode,device:this.device}),this.boxStyleMonitor=new I.Discovery.BoxStyleMonitor(this.targetNode),this.tdClientId,this.extra,this.data=[],this.articleImpCounter=0,this.r5Value,this.r5ValueWithChannelId,this.inrecsysCommonSendData,this._canSendChannelImpLog=!0,this.keyForInrecsys,this.brandSafety=e.brandSafety||{},this.inrecsysMaxArticleImpLog=e.inrecsysMaxArticleImpLog||3,this.tdMaxArticleImpLog=e.tdMaxArticleImpLog||3},{ARTICLE_TYPES:["ad","ad_reserved","recommend","hot","pop","e_ranking","cf"],MAX_ARTICLE_IMP_LOG:3,VALID_ELAPSED_FOR_IN_VIEW_LOG:1800,TD_LOG_TYPE_PV:0,TD_LOG_TYPE_IMP:1,TD_LOG_TYPE_CLICK:2,TD_LOG_TYPE_IN_VIEW:3,TD_LOG_TYPE_AD_RENDERED:4,TD_LOG_TYPE_IN_VIEWS:5,TD_LOG_TYPE_AD_RENDEREDS:6,TD_LOG_TYPE_BOX_PV:7,DELAY_TO_FORCE_TO_MOVE_PAGE:200,ARTICLE_CLICK_HISTORY_LOCAL_STORAGE_KEY:"_popIn_article_click_history",ARTICLE_REFERRER_RECOMMEND_TYPE:"_pi_article_recommend_type",setup:function(){var e=this.template,t=this._initialiseArticleList(),i=I.Common.Utils,n=this.channelId,n=this.template.channelId;this.extra="m_ch_"+n,this.r5Value=i.generateR5Value({ca:this.pageCategory,ab:this.abtest}),this.r5ValueWithChannelId=i.generateR5Value({ca:this.pageCategory,ab:this.abtest,ch:n}),this.keyForInrecsys="key"+this.beginTime,this.inrecsysCommonSendData=this._createInrecsysCommonSendData(),this.inrecsysDishData=this._createInrecsysDishData(),"object"==typeof e.customEvents&&this._registerCustomEvents(t,e.customEvents),this._registerLoggerEvents(t);t=t.setup();return!1===t&&this._sendErrorLog(),t},_sendErrorLog:function(){for(var e,t,i=this._mergeTDCommonSendData({pid:this.pid,channel_id:this.template.channelId,is_feed_module:this.template.isFeedModule,type:"rendering_failure",template_type:this._convertTypeToString(this.template.type)}),n=this.originalData,o=this.ARTICLE_TYPES,s=0,a=o.length;s<a;s++)e=n[t=o[s]],!0===Array.isArray(e)&&(i[t+"_count"]=e.length);this.logger.send("treasure",{db:"popin_media",table:"errorlogs",data:i})},_convertTypeToString:function(e){if(!1===Array.isArray(e))return e;if("pattern"!==e[0])return e.join(",");for(var t,i=[],n=1,o=e.length-1;n<o;n++)t=e[n],i.push(!0===Array.isArray(t)?t.join(","):t);return"pattern["+i.join("|")+"]"},_initialiseArticleList:function(){var e=this.template,t=this.originalData,i="mobile"===this.device;return new I.Discovery.ArticleList({apiHost:this.apiHost,tdClientId:this.tdTrackValue.td_client_id,hasInfiniteAds:!0==i&&!0===e.canInfiniteAds&&!0===Array.isArray(t.infinite)&&0<t.infinite.length,country:this.country,template:e,referrer:this.referrer,logid:this.logid,media:this.media,originalData:t,targetNode:this.targetNode,targetUrl:this.targetUrl,adInView:this.adInView,userInfo:this.userInfo,commonUseCfRatio:this.commonUseCfRatio,commonChannelPrefix:this.commonChannelPrefix,aboutPageType:e.aboutPageType||(!0==i?"newTab":"dialogue"),brandSafety:this.brandSafety,boxPosition:this.boxPosition,boxStyleMonitor:this.boxStyleMonitor,loc:this.loc})},_registerCustomEvents:function(e,t){var i,n;for(n in t)"function"==typeof(i=t[n])&&e.on(n,i)},_registerLoggerEvents:function(e){e.on("beforeRender",this._onBeforeRender.bind(this)),e.on("inView",this._onInView.bind(this)),e.on("imp",this._onImp.bind(this)),e.on("click",this._onClick.bind(this))},_onBeforeRender:function(){var e=encodeURIComponent(this.targetUrl),t=this.device,i=this.media,n=I.Common.Utils,o="preview|"+e;this.r5ValueWithChannelId=n.generateR5Value({ca:this.pageCategory,ab:this.abtest,ch:this.template.channelId}),this.logger.send("basic",{type:"normal",uniqueId:o,data:{url:e,uid:I.Common.Uid.getUid(),type:t+"_pv",nid:t,media:i,r5:this.r5Value||"cc_NONE"}}),this.logger.send("treasure",{db:"popin_media",table:"discoverylogs",uniqueId:o,data:this._mergeTDCommonSendData({r_url:"",type:this.TD_LOG_TYPE_PV})}),this.logger.send("inrecsys",{api:"other",uniqueId:o,data:this._mergeInrecsysCommonSendData({domain:d.host,v_dish_labels:this.originalData.v_dish_labels||"",v_dish_tlabels:this.originalData.v_dish_tlabels||""})}),this.template.channelId&&(this.logger.send("basic",{mode:"normal",data:{url:e,uid:I.Common.Uid.getUid(),type:t+"_channel_pv",nid:t,media:i,r5:this.r5ValueWithChannelId||"cc_NONE"}}),this.logger.send("treasure",{db:"popin_media",table:"discoverylogs",data:this._mergeTDCommonSendData({type:this.TD_LOG_TYPE_BOX_PV,channel_id:this.template.channelId,is_feed_module:this.template.isFeedModule,expected_ad:I.Common.Global.expectedAndRenderAds[this.template.channelId]?I.Common.Global.expectedAndRenderAds[this.template.channelId].expectedAdTotal:null,rendered_ad:I.Common.Global.expectedAndRenderAds[this.template.channelId]?I.Common.Global.expectedAndRenderAds[this.template.channelId].renderedAdTotal:null})})),!0===this.adEnable&&(s=this.originalData,i=I.Common.rid||"",a=I.Common.alg||"",this.logger.send("treasure",{db:"popin_ads",table:"adlogs",data:this._mergeTDCommonSendData({type:"req",time_show_seconds:this._getElapsed(),request_ad:this.ad,rid:i,alg:a,response_ad:s.ad.length,smjad:s.ad_smj&&0<s.ad_smj.length?1:0,af:s.af?s.af+"":""})}));var s,a=r._popIn_concatenation_param;"object"==typeof a&&(s={user_id:a.user_id,useragent_popin:a.useragent,timestamp:Date.now()},!0===/tabelog\.com/.test(d.href)&&(s.pv_time=a.pv_time,s.pv_hostname=d.host),this.logger.send("treasure",{db:"popin_media",table:"pageview_concatenation",uniqueId:"concatnation_pv|"+e,data:s}))},_onInView:function(e){var t=encodeURIComponent(this.targetUrl),i=this.media,n=this.device,o="inview|"+t;this.logger.send("basic",{mode:"normal",uniqueId:o,data:{url:t,uid:I.Common.Uid.getUid(),type:n+"_inview",nid:n,media:i,r5:this.r5Value||"cc_NONE"}}),this.logger.send("treasure",{db:"popin_media",table:"discoverylogs",uniqueId:o,data:this._mergeTDCommonSendData({r_url:"",type:this.TD_LOG_TYPE_IN_VIEW})}),this.logger.send("treasure",{db:"popin_media",table:"discoverylogs",data:this._mergeTDCommonSendData({r_url:"",channel_id:this.template.channelId,is_feed_module:this.template.isFeedModule,type:this.TD_LOG_TYPE_IN_VIEWS,box_position:this.boxPosition.getPosition()})}),this.template.channelId&&this.logger.send("basic",{mode:"normal",data:{url:t,uid:I.Common.Uid.getUid(),type:n+"_channel_inview",nid:n,media:i,r5:this.r5ValueWithChannelId||"cc_NONE"}})},_onImp:function(e,t){!0===t.isAd?this._onImpForAd(e,t):this._onImpForArticle(e,t)},_onImpForAd:function(e,s){var a=+e.dataset.ad_position,r=+e.dataset.position,t=I.Common.Storage,e=this.ARTICLE_REFERRER_RECOMMEND_TYPE,d=t.get("session",e),t=this.device,l=t+"_imp",c=this.media,h=s.nid,p=s.campaign,_=s.token,m=encodeURIComponent(this.targetUrl),g=I.Common.Utils,u=this.commonCategory,e="imp|"+m,f=s.imp||void 0,y=this.loc;this.logger.send("basic",{mode:"normal",uniqueId:e,data:{url:m,uid:I.Common.Uid.getUid(),type:l,nid:"",media:c,r5:g.generateR5Value({cc:u})||"cc_NONE"}}),this.template.channelId&&!0===this._canSendChannelImpLog&&(this.logger.send("basic",{mode:"normal",data:{url:m,uid:I.Common.Uid.getUid(),type:t+"_channel_imp",nid:"",media:c,r5:this.r5ValueWithChannelId||"cc_NONE"}}),this._canSendChannelImpLog=!1),this.logger.send("treasure",{db:"popin_media",table:"discoverylogs",uniqueId:e,data:this._mergeTDCommonSendData({r_url:"",type:this.TD_LOG_TYPE_AD_RENDERED})}),this.logger.send("treasure",{db:"popin_media",table:"discoverylogs",uniqueId:e+this.template.channelId,data:this._mergeTDCommonSendData({r_url:"",channel_id:this.template.channelId,is_feed_module:this.template.isFeedModule,type:this.TD_LOG_TYPE_AD_RENDEREDS})}),s.debug||this._getElapsed()>this.VALID_ELAPSED_FOR_IN_VIEW_LOG||setTimeout(function(){f?g.requestByImageBeacon(f):this.logger.send("basic",{mode:"normal",data:{url:m,uid:I.Common.Uid.getUid(),type:l,nid:h,campaign:p,media:c,r5:g.generateR5Value({cc:u||"NONE",lc:y}),r6:_}});var e={time_show_seconds:this._getElapsed(),nid:h,campaign:p,token:_,timestamp:Date.now(),recommend_position:r,ad_position:a,image_hash:s.imageHash||"",image:s.image||"",sample:s.sample||"",classify:s.classify||"",v_fruit_word:s.vFruitWord||"",fruit_style:s.articleStyleMonitor&&s.articleStyleMonitor.getStyleFlag(),box_style:this.boxStyleMonitor&&this.boxStyleMonitor.getStyleFlag()},t=this.originalData.sample_tag;void 0!==s.clarity&&(e.clarity=s.clarity),void 0!==s.aesthetic&&(e.aesthetic=s.aesthetic),g.setValueToObjectIfConditionIsMet(!!s.c1,s.c1,"c1",e),g.setValueToObjectIfConditionIsMet(!!s.c2,s.c2,"c2",e),g.setValueToObjectIfConditionIsMet(!!t,t,"sample_tag",e);t=Object.assign({title:s.title||""},e);if(t.r_url="",t.type=!0===s.isReserved?"reserved_imp":"imp",t.channel_id=this.template.channelId,t.referrer_recommend_type=d||"",this.logger.send("treasure",{db:"popin_ads",table:"adlogs",data:this._mergeTDCommonSendData(t)}),!1===s.isReserved){var i=["smjId","client_id","c1","popin_version","td_global_id","td_version","td_charset","td_language","td_path"],e=Object.assign({fruit_userid:s.userid||"",fruit_title:s.title||"",fruit_domain:s.domain||"",fruit_business_type:s.businessType||"",v_dish_labels:this.originalData.v_dish_labels||"",v_dish_tlabels:this.originalData.v_dish_tlabels||"",fruit_campaign:p||"",recommend_position:r,ad_position:a,channel_id:this.template.channelId,box_position:this.boxPosition.getPosition(),fruit_style:s.articleStyleMonitor&&s.articleStyleMonitor.getStyleFlag(),box_style:this.boxStyleMonitor&&this.boxStyleMonitor.getStyleFlag()},e);e.type="imp",e.timestamp=I.Common.Global.startTime,delete e.campaign;for(var n=this._mergeInrecsysCommonSendData(e),o=0;o<i.length;o++)delete n[i[o]];this.logger.send("inrecsys",{api:"ad",data:n})}void 0!==s.trackingPixel&&g.writeCodeInIframe(s.trackingPixel),s.dspObj&&s.dspObj.execDspFunc("imp",s)}.bind(this),1e3)},_onImpForArticle:function(e,t){var i=Number(e.dataset.position);this.articleImpCounter<this.tdMaxArticleImpLog&&this.logger.send("treasure",{db:"popin_media",table:"discoverylogs",data:Object.assign(this._mergeTDCommonSendData(),this._createArticleCommonSendData(),{r_url:t.url,type:this.TD_LOG_TYPE_IMP,recommend_type:t.type,recommend_position:i,channel_id:this.template.channelId,is_feed_module:this.template.isFeedModule,recall_refer:t.recallRefer})}),this.articleImpCounter<this.inrecsysMaxArticleImpLog&&((e=this._createFruitDataForInrecsys(t,Number(e.dataset.position))).api_host=d.host,e.type="imp",e.recommend_position=i,this.logger.send("inrecsys",{api:"discovery",data:Object.assign(this._mergeInrecsysCommonSendData(e),this._createArticleCommonSendData())})),this.articleImpCounter++},_onClick:function(e,t){var i=e.href,n="_blank"===e.target,o=Number(e.dataset.position);Number(e.dataset.ad_position);!0===t.isAd?this._onClickAd(i,t,o,n):this._onClickArticle(i,t,o,n)},_onClickArticle:function(e,t,i,n){this.isMoved=!1,this._writeArticleClickHistory(e);var o,s=I.Common.Storage,a=this.ARTICLE_REFERRER_RECOMMEND_TYPE,r=t.type;s.set("session",a,r),!0===n?this._openNewTab(e):o=this._movePage.bind(this,e);e=this.device;this.logger.send("basic",{type:"normal",data:{url:"",uid:I.Common.Uid.getUid(),type:e+"_rclick",nid:e,media:this.media,r5:this.r5ValueWithChannelId||"cc_NONE"},onComplete:o,onError:o}),this.logger.send("treasure",{db:"popin_media",table:"discoverylogs",data:Object.assign(this._mergeTDCommonSendData(),this._createArticleCommonSendData(),{r_url:t.url,type:this.TD_LOG_TYPE_CLICK,channel_id:this.template.channelId,is_feed_module:this.template.isFeedModule,recommend_type:t.type,recommend_position:i,extra:this.extra,recall_refer:t.recallRefer})});t=this._createFruitDataForInrecsys(t,i);t.api_host=d.host,t.type="click",t.recommend_position=i,this.logger.send("inrecsys",{api:"discovery",data:Object.assign(this._mergeInrecsysCommonSendData(t),this._createArticleCommonSendData())}),"function"==typeof o&&setTimeout(o,this.DELAY_TO_FORCE_TO_MOVE_PAGE)},_writeArticleClickHistory:function(e){var t=I.Common.Storage,i=this.ARTICLE_CLICK_HISTORY_LOCAL_STORAGE_KEY,n=t.get("local",i),n=(null===n?[]:JSON.parse(n)).filter(this._isNotSameHistoryURL.bind(this,e));n.push({url:e,timestamp:Date.now()}),t.set("local",i,JSON.stringify(n))},_isNotSameHistoryURL:function(e,t){return t.url!==e},_createArticleCommonSendData:function(){return Object.assign({},this.originalData.identity)},_createInrecsysDishData:function(){return{dish_domain:I.Common.Utils.getRootDomain(d.host),dish_td_title:this.originalData.title,dish_pubdate:this.originalData.pubdate,dish_category:this.originalData.category,dish_td_url:this.targetUrl,dish_media:this.media,device:this.device}},_createFruitDataForInrecsys:function(e,t){var i=I.Common.Utils;return this._mergeInrecsysDishData({fruit_common_category:"",fruit_domain:i.getRootDomain(i.parseUri(e.originalUrl).host),fruit_td_title:e.title,fruit_title:e.originalTitle,fruit_pubdate:e.pubdate,fruit_category:e.category,fruit_td_url:e.pureUrl,fruit_media:e.media,fruit_image:e.image,image_hash:e.imageHash,fruit_recommend_type:e.type,fruit_recommend_position:t,recall_refer:e.recallRefer,recommend_position:t})},_onClickAd:function(e,t,i,n,o){var s={type:"click",time_show_seconds:this._getElapsed(),nid:t.nid,campaign:t.campaign,token:t.token,position:i,recommend_position:i,ad_position:o,timestamp:Date.now(),isSmjAd:t.isSmjAd?1:0,extra:this.extra},i=this.originalData.sample_tag,o=I.Common.Utils;o.setValueToObjectIfConditionIsMet(!!t.c1,t.c1,"c1",s),o.setValueToObjectIfConditionIsMet(!!t.c2,t.c2,"c2",s),o.setValueToObjectIfConditionIsMet(!!i,i,"sample_tag",s),this.logger.send("treasure",{db:"popin_ads",table:"adlogs",data:this._mergeTDCommonSendData(s)}),void 0!==t.clickTrackingPixel&&o.writeCodeInIframe(t.clickTrackingPixel),t.dspObj&&t.dspObj.execDspFunc("click",t),!0===n?this._openNewTab(e):(this.isMoved=!1,this._movePage(e))},_openNewTab:function(e){r.open(e,"_blank")},_movePage:function(e){this.isMoved||(this.isMoved=!0,r.top.location.href=e)},_mergeInrecsysDishData:function(e){return Object.assign(e||{},this.inrecsysDishData)},_mergeInrecsysCommonSendData:function(e){return Object.assign(e||{},this.inrecsysCommonSendData)},_createInrecsysCommonSendData:function(){var e=this._mergeTDCommonSendData({key:this.keyForInrecsys,client_id:this.tdClientId,url:this.targetUrl,uid:I.Common.Uid.getUid(),popin_user_id:I.Common.Uid.getUid(),smjId:this.smjId||""});e.td_ip=this.originalData.ip||e.td_ip,I.Common.Utils.setValueToObjectIfConditionIsMet(void 0!==this.logid,this.logid,"logid",e),e.dish_common_category=e.common_category,e.dish_media=e.media,delete e.common_category,delete e.media;for(var t,i=["td_browser","td_browser_version","td_os","td_os_version"],n=0,o=i.length;n<o;n++)e[t=i[n]]=this.userInfo[t.replace(/td_/,"")];return e}})}(window.PopIn,window,window.location),function(a,r){"use strict";var d=a.Discovery;a.createClass("Discovery.Widget",function(e){e=e||{},this.commonUseCfRatio=e.commonUseCfRatio,this.commonChannelPrefix=e.commonChannelPrefix,this.pid=e.pid,this.adEnable=e.adEnable||!1,this.adVideo=e.adVideo||!1,this.ad=e.ad,this.apiHost=e.apiHost||"",this.device=e.device,this.media=e.media,this.adInView=e.adInView||!1,this.referrer=e.referrer||"",this.abtest=e.abtest||void 0,this.popInUserId=a.Common.Uid.getUid(),this.smjId=e.smjId||"",this.targetNode=e.targetNode,this.country=e.country,this.targetUrl=e.targetUrl,this.template=e.template||{},this.beginTime=e.beginTime,this.userInfo=e.userInfo,this.brandSafety=e.brandSafety||{},this.originalData=e.originalData||{},this.logger=e.logger,this.inrecsysMaxArticleImpLog=e.inrecsysMaxArticleImpLog,this.tdMaxArticleImpLog=e.tdMaxArticleImpLog,this.channelId,this.pageCategory,this.commonCategory,this.tdCommonSendData,this.tdTitle,this.loc},{TEST_AD_PARAMETER_RESPONSE_KEY_MAP:{adid:"ad",adimage:"ad_image"},TEST_AD_URL_PARAMETER_REGEXP:/popin(videotest|adid|adimage)=([\w\d]+)/,TEST_AD_DATA_REQUEST_URL:"https://dashboard.popin.cc/discovery/accounts/index.php/guest/getAdData?adtest=",setup:function(){var e=this.template,t=this.originalData;this.tdTrackValue=this.logger.getTrackValues(),this.pageCategory=t.category||void 0,this.loc=t.loc||void 0,this.commonCategory=Array.isArray(t.common_category)?t.common_category[0]:void 0,this.logid=t.logid,this.channelId=e.channelId||"",this.tdTitle=t.title,this.tdCommonSendData=this._createTreasureCommonSendData();var i=this._getTestAdNIDFromURL(r.location.href),n="object"==typeof i;if(!0==n&&!0===/^ad(id|image)$/.test(i.type)){var o=i.nid,s=this.TEST_AD_PARAMETER_RESPONSE_KEY_MAP[i.type];this._initialiseModuleForDemo(o,this._onResponseForRecommendADDemo.bind(this,o,s))}else if(!1===this._initialiseRecommendModule())return!1;s=e.adVideoInsertSelector||void 0;return!0==("mobile"===this.device&&void 0!==s)&&(!0==n&&"videotest"===i.type?(i=i.nid,a.Common.Storage.remove("session",d.VideoModule.prototype.SESSION_STORAGE_KEY_HISTORY),this._initialiseModuleForDemo(i,this._onResponseForVideoDemo.bind(this,i))):!0===this.adVideo&&0<t.ad_video.length&&this._initialiseVideoModule(t.ad_video,s,e.adVideoInsertPosition)),!0},_getTestAdNIDFromURL:function(e){e=e.match(this.TEST_AD_URL_PARAMETER_REGEXP);return null!==e&&2<e.length?{type:e[1],nid:e[2]}:void 0},_initialiseRecommendModule:function(){return this._generateRecommendModule().setup()},_initialiseVideoModule:function(e,t,i){i=i||"AfterBegin";t=this.targetNode.querySelector(t);!e||null===t||!0===(e=this._generateVideoModule(e)).setup()&&a.Common.Utils.renderNode(e.node,t,i)},_createTreasureCommonSendData:function(){var e={api_host:this.apiHost,category:this.pageCategory,device:this.device,media:this.media,url:this.targetUrl,popin_user_id:this.popInUserId||"",uid:this.popInUserId,smjId:this.smjId},t=a.Common.Utils;return t.setValueToObjectIfConditionIsMet(!!this.abtest,this.abtest,"abtest",e),t.setValueToObjectIfConditionIsMet(!!this.commonCategory,this.commonCategory,"common_category",e),t.setValueToObjectIfConditionIsMet(!!this.logid,this.logid,"logid",e),(e=Object.assign(e,this.tdTrackValue)).td_title=this.tdTitle,e.client_id=this.tdTrackValue.td_client_id,e},_getModuleCommonValues:function(){return{apiHost:this.apiHost,media:this.media,abtest:this.abtest,device:this.device,country:this.country,popInUserId:this.popInUserId,targetUrl:this.targetUrl,beginTime:this.beginTime,logger:this.logger,channelId:this.channelId,pageCategory:this.pageCategory,brandSafety:this.brandSafety,commonCategory:this.commonCategory,smjId:this.smjId,logid:this.logid,tdCommonSendData:this.tdCommonSendData,tdTrackValue:this.tdTrackValue,inrecsysMaxArticleImpLog:this.inrecsysMaxArticleImpLog,tdMaxArticleImpLog:this.tdMaxArticleImpLog,loc:this.loc}},_generateRecommendModule:function(){return new d.RecommendModule(Object.assign(this._getModuleCommonValues(),{pid:this.pid,adEnable:this.adEnable,ad:this.ad,targetNode:this.targetNode,adInView:this.adInView,referrer:this.referrer,template:this.template,userInfo:this.userInfo,originalData:this.originalData,commonUseCfRatio:this.commonUseCfRatio,commonChannelPrefix:this.commonChannelPrefix}))},_generateVideoModule:function(e){return new d.VideoModule(Object.assign(this._getModuleCommonValues(),{data:e}))},_initialiseModuleForDemo:function(e,t){e=this.TEST_AD_DATA_REQUEST_URL+e;a.Common.Utils.requestByJSONP(e,t)},_onResponseForRecommendADDemo:function(e,t,i){"object"==typeof i&&i.origin_url&&(this.originalData[t]=[{title:i.title,url:i.url,image:i.image,media:i.media,nid:i._id.$id,position:i.position||"",type:i.type||"",campaign:"campaign_test"}],this._initialiseRecommendModule())},_onResponseForVideoDemo:function(e,t){"object"==typeof t&&(t.nid=e,e=this.template,this._initialiseVideoModule([t],e.adVideoInsertSelector,e.adVideoInsertPosition))}})}(window.PopIn,window),function(a,r,d,l){"use strict";a.createClass("Discovery",["VideoPlayer","Common.Publisher","Common.Logger"],function(e){e=e||{},this.commonUseCfRatio=e.useCfRatio,this.commonChannelPrefix=e.cfChannelPrefix,this.useForSzAdLtrRatio=e.useForSzAdLtrRatio,this.infiniteLoadPage=e.infiniteLoadPage,this.useSzAdLtrChannelIdPrefix=e.useSzAdLtrChannelIdPrefix,this.adEnable=e.adEnable||!1,this.adVideo=e.adVideo||!1,this.adInView=e.adInView||!1,this.target=e.target||l.href,this.apiUrl=e.apiUrl,this.templates=e.templates||[],this.apiUrlAdd=e.apiUrlAdd||"",this.media=e.media||l.host,this.agency=e.agency||"popinag",this.pathnum=e.pathnum,this.topn=e.topn||50,this.ad=e.ad||10,this.abtest=e.abtest||"",this.inrecsysMaxArticleImpLog=e.inrecsysMaxArticleImpLog,this.tdMaxArticleImpLog=e.tdMaxArticleImpLog,this.pid=e.pid,this.urlReplace=e.urlReplace,this.apiHost="",this.device,this.findingCount=0,this.country="",this.referrer="",this.requestUrl="",this.popInUserId="",this.beginTime,this.userInfo,this.userTdInfo,this.multipleWidgetNodes=[],this.logger;e=this.constructor;void 0===e._renderedTargetNodes&&(e._renderedTargetNodes=[]),void 0===e._templatesForMultipleWidget&&(e._templatesForMultipleWidget=[])},{INTERVAL_TO_FIND_NODE:500,PERCENTAGE_TO_SEND_FACEBOOK_REQUEST:.1,FACEBOOK_API_REQUEST:"https://graph.facebook.com/?id=",MIN_SHARE_COUNT_TO_SEND_SNS_LOG:30,DEFAULT_SELCTOR_FOR_AMP:"#_popIn_amp_recommend",setup:function(){var e=this.templates;if(!1===Array.isArray(e)||0===e.length)return!1;this.logger=a.Common.Logger,this._setRequestCountryToPopin(),this.brandSafety=new this.constructor.BrandSafety,this.beginTime=Date.now();for(var t=e.filter(this._isValidTemplate),i=a.Common.CSSManager,n=0,o=t.length;n<o;n++)i.add(t[n].css);i.render();var s=this._prepareForMultipleWidget(t),e=this._generateLoader(this.target);e.on("response",this._syncDspCookie.bind(this)),e.on("response",this._onResponseForSingleWidget.bind(this,s)),e.load()},_sendLogsForCrawling:function(e,t){e=encodeURIComponent(e);this.logger.send("basic",{mode:"other",uniqueId:"related|"+e,data:{type:"related"+("string"==typeof t&&0!==t.length?"-"+t:""),uid:"",url:e}}),Math.random()<this.PERCENTAGE_TO_SEND_FACEBOOK_REQUEST&&a.Common.Utils.requestByJSONP(this.FACEBOOK_API_REQUEST+e,this._onGetFacebookResponse.bind(this,e,t))},_onGetFacebookResponse:function(e,t,i){i="object"==typeof i&&"object"==typeof i.share?i.share.share_count:0;i<this.MIN_SHARE_COUNT_TO_SEND_SNS_LOG||this.logger.send("basic",{mode:"normal",uniqueId:"share|"+e,data:{url:e,share:i,type:"share-"+("string"==typeof t?t:"jp")}})},_onResponseForSingleWidget:function(e,t){var i,n,o,s;this._sendLogsForCrawling(t.target,t.country),0!==e.length&&(this._updateInformation(t),i=t.responseData,n=this.target,"object"==typeof(o=r.context)&&"AMP-AD"===o.tagName&&(0===(s=e.filter(this._isAMP.bind(this))).length?o.noContentAvailable():(t=s[0],s=e.indexOf(t),e.splice(s,1),this._initialiseWidgetsForAMP(n,o,t,i))),this._initialiseWidgets(n,e,i))},_generateLoader:function(e){return new a.Common.Loader({target:e,apiUrl:this.apiUrl,apiUrlAdd:this.apiUrlAdd,device:this.device,media:this.media,agency:this.agency,pathnum:this.pathnum,topn:this.topn,ad:!0===this.adEnable?this.ad:0,urlReplace:this.urlReplace,needUserTdInfo:!0,needRecommendInformation:!0,useForSzAdLtrRatio:this.useForSzAdLtrRatio,infiniteLoadPage:this.infiniteLoadPage,useSzAdLtrChannelIdPrefix:this.useSzAdLtrChannelIdPrefix,templates:this.templates})},_updateInformation:function(e){this.target=e.target,this.device=e.device,this.referrer=e.referrer,this.apiHost=e.apiHost,this.country=e.country,this.requestUrl=e.requestUrl,this.popInUserId=e.popInUserId,this.userInfo=e.userInfo,this.userTdInfo=e.userTdInfo},_isAMP:function(e){return e.selector===this.DEFAULT_SELCTOR_FOR_AMP},_initialiseWidgetsForAMP:function(e,i,t,n){i.onResizeDenied(function(e,t){setTimeout(function(){i.requestResize(t,e)},500)}),t.aboutPageType="sameTab",t.isTargetTop=!0,this._initialiseWidget(e,t,n,this._sendeRenderStartRequestForAMP.bind(this,i))},_sendeRenderStartRequestForAMP:function(e){var t=d.querySelector(this.DEFAULT_SELCTOR_FOR_AMP),i=t.offsetWidth+"px",t=t.offsetHeight+"px";e.renderStart({width:i,height:t})},_initialiseWidgets:function(e,t,i){for(var n=0,o=(t=t||[]).length;n<o;n++)this._initialiseWidget(e,t[n],i)},_prepareForMultipleWidget:function(e){for(var t,i=this.constructor,n=new a.Common.Timer,o=e.concat(),s=o.length-1;0<=s;s--)!0===(t=o[s]).isMultiple&&(!1===this._hasSameSelectorInTemplatesForMultipleWidget(t.selector)&&i._templatesForMultipleWidget.push(t),o.splice(s,1),void 0===i._timerForFindingNode&&(i._timerForFindingNode=n.set(this._findNodeForMultipleWidget.bind(this),this.INTERVAL_TO_FIND_NODE)));return o},_initialiseMultipleWidget:function(e){for(var t,i,n=Array.apply(null,d.querySelectorAll(e.selector)).filter(this._isNotRendered.bind(this)),o=l.href,s=0,a=n.length;s<a;s++)i=(t=n[s]).dataset.url||o,this._generateMultipleWidget(i,t,e)},_generateMultipleWidget:function(e,t,i){this.constructor._renderedTargetNodes.push(t);e=this._generateLoader(e);e.on("response",this._onResponseForMultipeWidget.bind(this,t,i)),e.load()},_onResponseForMultipeWidget:function(e,t,i){this._sendLogsForCrawling(i.target,i.country),this._updateInformation(i),this._setupWidget(i.target,e,t,i.responseData)},_findNodeForMultipleWidget:function(){for(var e=this.constructor._templatesForMultipleWidget,t=0,i=e.length;t<i;t++)this._initialiseMultipleWidget(e[t])},_hasSameSelectorInTemplatesForMultipleWidget:function(e){for(var t=this.constructor._templatesForMultipleWidget,i=0,n=t.length;i<n;i++)if(t[i].selector===e)return!0;return!1},_isRendered:function(e){return a.Common.Utils.includes(e,this.constructor._renderedTargetNodes)},_isNotRendered:function(e){return!1===this._isRendered(e)},_initialiseWidget:function(e,t,i,n){var o=d.querySelector(t.selector);null!==o?(!0===this._isNotRendered(o)&&this.constructor._renderedTargetNodes.push(o),this._setupWidget(e,o,t,i),"function"==typeof n&&n()):setTimeout(this._initialiseWidget.bind(this,e,t,i,n),this.INTERVAL_TO_FIND_NODE)},_setupWidget:function(e,t,i,n){new this.constructor.Widget({commonUseCfRatio:this.commonUseCfRatio,commonChannelPrefix:this.commonChannelPrefix,pid:this.pid,adEnable:this.adEnable,adVideo:this.adVideo,apiHost:this.apiHost,topn:this.topn,ad:this.ad,adInView:this.adInView,country:this.country,device:this.device,popInUserId:this.popInUserId,referrer:this.referrer,abtest:this.abtest,originalData:n,template:i,media:this.media,targetUrl:e,targetNode:t,userInfo:this.userInfo,beginTime:this.beginTime,logger:this.logger,brandSafety:this.brandSafety,inrecsysMaxArticleImpLog:this.inrecsysMaxArticleImpLog,tdMaxArticleImpLog:this.tdMaxArticleImpLog}).setup()},_isValidTemplate:function(e){e=e.type,e=e[e.length-1];return"number"!=typeof e||0<e},_setRequestCountryToPopin:function(){if(!a.REQUEST_COUNTRY){for(var e="jp",t=/.*country=(\w+).*/,i=[this.apiUrl,this.apiUrlAdd],n=0,o=i.length;n<o;n++)t.test(i[n])&&(e=i[n].replace(t,"$1"));Object.defineProperty(a,"REQUEST_COUNTRY",{value:e,writable:!1})}},_syncDspCookie:function(e){var t,i=e.responseData,e=i.cookie,n=i.cookie_sync;if(n&&e&&e.uid)for(var o in n){1!==n[o]||(t=new a.Discovery.Dsp(o)).setup()&&t.execDspFunc("cookieSync")}}})}(window.PopIn,window,document,location);