!function(o,h){"use strict";var s=o.Read;o.inherit("Read.Analyser","Common.Publisher",function(t){t=t||{},this.node=t.node,this.url=t.url,this.urlReplace=t.urlReplace||[],this.media=t.media,this.device=t.device,this.referrer=t.referrer,this.popInUserId=t.popInUserId,this.apiHost=t.apiHost,this.pageCategory=t.pageCategory,this.commonCategory=t.commonCategory,this.customField=t.customField,this.nid=t.nid,this.sessionHistory=t.sessionHistory,this.country=t.country,this.articleReadId=t.articleReadId,this.isClickedAd=t.isClickedAd||!1,this.ignoredNodeNames=t.ignoredNodeNames||void 0,this.campaign=t.campaign,this.nid=t.nid,this.clickCategory=t.clickCategory,this.textSpeed=t.textSpeed,this.imageSpeed=t.imageSpeed,this.isDebug=t.isDebug||!1,this.isNewSession=t.isNewSession||!1,this.sendLogTiming=t.sendLogTiming,this.stopNode=t.stopNode,this.logger=t.logger,this.articleArea,this.retargetingMessenger,this.debug,this.updateCount=0,this.isCompleted=!1,this._currentTimeForLog=0,this._currentReadingPercentageForLog=void 0,this._sentLogs={},this._mainCategoryForTreasure,this.shouldSendPaidLog=!1,this.enabled=!1},{IGNORED_NODE_NAMES:["A","IFRAME","SCRIPT","H1","H2","H3","H4","NOSCRIPT","STYLE"],MIN_IMAGE_AREA:4e4,TEXT_MIN_LENGTH:5,PERCENTAGE_TO_REGARD_IMAGE:.4,PARTITION_HEIGHT:10,READ_HISTORY_SESSION_STORAGE_KEY:"__read",RETARGETING_PAGE_URL:o.PROTOCOL+"//api.popin.cc/iframe/article_read.html",setup:function(){this.shouldSendPaidLog=/paid_/.test(this.referrer),this._tdTrackValues=this.logger.getTrackValues(),this._mainCategoryForTreasure=this._generateMainCategory(this.commonCategory);var t=this._initialiseModules(this.node),e=t.articleArea,i=o.Common.Utils,s=100*Math.round(e.textCount/100),n=Math.round(100*e.imagePartitionCount/e.partitions.length),a=this._generateInOutValues(s,n);if(this._allR3Value=i.generateBasicLogValue(a),this._readStatValues=this._generateReadStatValues(a),this._outR=a.out_r,this._inTextValue=s,this._inImageValue=n,void 0!==this.articleReadId){var r=new o.Common.Messenger({url:this.RETARGETING_PAGE_URL});r.setup(),this.retargetingMessenger=r}this.articleArea=e,this.debug=t.debug,this.isCompleted=!1,this._currentTimeForLog=0,this._currentReadingPercentageForLog=void 0,this._sentLogs={},this.enabled=!0},_initialiseModules:function(t){var e,i=new s.ArticleArea({node:t,stopNode:this.stopNode,dividingHeight:this.PARTITION_HEIGHT,ignoredNodeNames:this.ignoredNodeNames||this.IGNORED_NODE_NAMES,minImageArea:this.MIN_IMAGE_AREA,textMinLength:this.TEXT_MIN_LENGTH,imageAreaPercentage:this.PERCENTAGE_TO_REGARD_IMAGE,textSpeed:this.textSpeed,imageSpeed:this.imageSpeed});return i.setup(),!0===this.isDebug&&(e=new s.Debug({width:i.width,height:i.height,x:i.left,y:i.top,country:this.country})).setup(),{articleArea:i,debug:e}},_generateInOutValues:function(t,e){var i=(this.sessionHistory||"").split("|");return{text:t,image:e,in_text:t,in_image:e,out_text:i[0]||void 0,out_image:i[1]||void 0,out_r:i[2]||void 0}},_generateReadStatValues:function(t){var e={};for(var i in t)e["read_stat_"+i]=Number(t[i]);return e},_generateMainCategory:function(t){if("string"==typeof t&&0!==t.length){var e=t.split("_");return 0<e.length?e[0]:void 0}},update:function(t,e,i){if(this.trigger("analyse",null,this),!1!==this._updateEnabled()){this.updateCount++;var s=this.articleArea.update(t,e,i);if(!0===this.isDebug&&this.debug.update(s,e,i),!1!==s&&(1<=s.currentReadingPercentage&&(this.isCompleted=!0),this.trigger("update",s,this),!1!==this._isTimingToSendLog())){var n=o.Common.Utils.replaceAll(h.href,this.urlReplace);this.url!==n&&(this.url=n),this._sendOneTimeOnlyLogs(s);var a=this._formatResultValuesForLog(s),r=a.currentPercentage;!1!==this._sendIntervalLogs(a)&&(this._saveHistory(this._inTextValue+"|"+this._inImageValue+"|"+r),this._currentTimeForLog=a.currentTime,this._currentReadingPercentageForLog=r,void 0!==this.retargetingMessenger&&this._sendArticleRetargetingLog(a),this.trigger("logged",a,this))}}},_sendArticleRetargetingLog:function(t){this.retargetingMessenger.send({action:"updateArticleRead",payload:{articleId:this.articleReadId,readPercent:t.currentPercentage}})},_updateEnabled:function(){var t=this._checkWhetherNodeIsValid(this.node);return!0===this.isDebug&&this.debug.changeEnabled(t),this.enabled=t},_checkWhetherNodeIsValid:function(t){return"object"==typeof t&&0<t.clientHeight&&0<t.clientWidth},_sendOneTimeOnlyLogs:function(t){this._sendOneTimeOnlyLogIfConditionIsMet("paidLog",!0===this.shouldSendPaidLog,"_sendPaidLog"),this._sendOneTimeOnlyLogIfConditionIsMet("viewAll",1<=t.currentViewingPercentage,"_sendViewAllLog"),this._sendOneTimeOnlyLogIfConditionIsMet("read70",.7<=t.currentReadingPercentage&&void 0!==this.nid&&void 0!==this.clickCategory,"_sendRead70Log")},_formatResultValuesForLog:function(t){var e=10*Math.round(10*t.currentReadingPercentage),i=this._currentReadingPercentageForLog,s=void 0===i,n=s?0:i;return{isFirstLog:s,currentTime:t.currentReadingTime,previousTime:this._currentTimeForLog,currentPercentage:e,previousPercentage:n}},_sendIntervalLogs:function(t){var e=t.currentPercentage;if(e<=0||!1===t.isFirstLog&&e===t.previousPercentage)return!1;this._sendBasicLog(t),this._sendTreasureLog(t.currentTime,e)},_sendOneTimeOnlyLogIfConditionIsMet:function(t,e,i){!0!==this._sentLogs[t]&&!1!==e&&(this[i](),this._sentLogs[t]=!0)},_isTimingToSendLog:function(){return this.updateCount%this.sendLogTiming==0},_sendTreasureLog:function(t,e){var i=h.host;this.logger.send("treasure",{db:"popin_media",table:"readlogs",data:Object.assign({image:this.imageUrl||"",pubdate:this.pubdate||"",category:this.pageCategory||"",read_re:this.referrer,read_cc:this.commonCategory,read_ca:this.pageCategory,read_au:this.customField,campaign:this.campaign,main_category:this._mainCategoryForTreasure,popin_user_id:this.popInUserId,domain:i,media:this.media||i,nid:this.nid,device:this.device,api_host:this.apiHost||"jp.popin.cc",read:e,read_time:Math.round(10*t)/10},this._readStatValues,this._tdTrackValues)})},_sendViewAllLog:function(){var t=this.device;this.logger.send("basic",{type:"normal",data:{url:encodeURIComponent(this.url),uid:"",type:t+"_viewall",nid:t,media:this.media,r5:o.Common.Utils.generateR5Value({ca:this.pageCategory,au:this.customField})}})},_sendRead70Log:function(){this.logger.send("basic",{type:"normal",data:{url:encodeURIComponent(this.url),uid:"",type:this.device+"_read70",nid:this.nid,campaign:this.campaign,media:this.media,r5:this.clickCategory}})},_sendPaidLog:function(){this.logger.send("basic",{type:"normal",data:{url:encodeURIComponent(this.url),uid:"",type:this.referrer}})},_sendBasicLog:function(t){var e=t.currentTime,i=t.previousTime,s=t.isFirstLog;this.logger.send("basic",{type:"normal",data:{url:encodeURIComponent(this.url),uid:this.popInUserId,nid:this.nid,media:this.media,r1:t.currentPercentage,r2:t.previousPercentage,r3:s?this._allR3Value:"text"+this._inTextValue+"|image"+this._inImageValue,r4:Math.round(e-i),r5:this._generateReadR5ValueForStatusLog(s),r6:Math.round(e),r7:-Math.round(i),r8:s?this.articleArea.totalRequiredTime:void 0}})},_saveHistory:function(t){o.Common.Storage.set("session",this.READ_HISTORY_SESSION_STORAGE_KEY,t)},_generateReadR5Value:function(t){return t.filter(function(t){return void 0!==t}).map(function(t){return encodeURIComponent(t)}).join("|")},_generateReadR5ValueForStatusLog:function(t){return this._generateReadR5Value(["string"==typeof this.pageCategory?"ca_"+this.pageCategory:void 0,"string"==typeof this.customField?"au_"+this.customField:void 0,"string"==typeof this.referrer?"re_"+this.referrer:void 0,"dv_"+this.device,t&&this._outR?"out_r"+this._outR:void 0,t&&!0===this.isNewSession?"session":void 0,t?"sstorage":void 0,this.clickCategory])}})}(window.PopIn,window.location),function(g){"use strict";var r=g.Read,o=Node.ELEMENT_NODE,h=Node.TEXT_NODE;g.createClass("Read.ArticleArea",function(t){t=t||{},this.node=t.node,this.stopNode=t.stopNode,this.width,this.height,this.top,this.left,this.right,this.bottom,this.containedImageNodes,this.totalRequiredTime,this.totalRequiredTimeForReading,this.totalRequiredTimeForViewingImage,this.textSpeed=t.textSpeed,this.imageSpeed=t.imageSpeed,this.dividingHeight=t.dividingHeight,this.ignoredNodeNames=t.ignoredNodeNames||[],this.minImageArea=t.minImageArea||0,this.textMinLength=t.textMinLength||0,this.imageAreaPercentage=t.imageAreaPercentage||0,this.partitions=[],this.area=0,this.currentReadingTime=0,this.currentReadingPercentage=0,this.currentViewingPercentage=0,this.textPartitionCount=0,this.imagePartitionCount=0},{setup:function(){var t=g.Common.Utils,e=this.node,i=t.getSize(e),s=t.getPosition(e),n=this._countText(e),a=this._getTextBottom(e),r=a-s.top,o=0<r?r:i.height,h=this._getValidImageNodes(Array.apply(null,e.getElementsByTagName("img"))),d=this._calculateNodesArea(h),u=n/this.textSpeed,l=d/this.imageSpeed;this.width=i.width,this.height=o,this.top=s.top,this.left=s.left,this.right=s.right,this.bottom=a||s.bottom,this.containedImageNodes=h,this.textCount=n,this.totalRequiredTime=u+l,this.totalRequiredTimeForReading=u,this.totalRequiredTimeForViewingImage=l;var c=this._generatePartitionInformation();this.partitions=c.partitions,this.textPartitionCount=c.textPartitionCount,this.imagePartitionCount=c.imagePartitionCount,this.area=c.area},update:function(t,e,i){var s=this._getVisiblePartition(e,i),n=s.length;if(0===n)return!1;for(var a,r=t/(n*this.area),o=0,h=!1;o<n;)(a=s[o]).update(r),h=h||a.isUpdated,o++;if(!1===h)return!1;var d=this._calculateTotalPercentages(this.partitions);return{partitions:this.partitions,currentReadingTime:this.currentReadingTime=Math.min(this.currentReadingTime+t,this.totalRequiredTime),currentReadingPercentage:this.currentReadingPercentage=d.currentReadingPercentage,currentViewingPercentage:this.currentViewingPercentage=d.currentViewingPercentage}},_countText:function(t){var e=0;switch(t.nodeType){case o:if(this.stopNode===t)return!1;if(this._isIgnoredNode(t))return 0;for(var i=t.childNodes,s=0,n=0,a=i.length;n<a;n++){if(!1===(s=this._countText(i[n])))return e;e+=s}break;case h:e=this._eraseText(t.textContent).length}return e},_getTextBottom:function(t,e){switch(e=e||0,t.nodeType){case o:if(this.stopNode===t)return!1;if(this._isIgnoredNode(t))return e;for(var i,s=t.childNodes,n=0,a=s.length;n<a;n++){if(!1===(i=this._getTextBottom(s[n],e)))return e;e=i}break;case h:this._eraseText(t.textContent).length>this.textMinLength&&(e=Math.max(e,this._getBottom(t.parentNode)))}return e},_getValidImageNodes:function(t){return t.filter(this._isValidImageNode.bind(this))},_isValidImageNode:function(t){return g.Common.Utils.calculateNodeArea(t)>=this.minImageArea},_calculateNodesArea:function(t){for(var e=0,i=g.Common.Utils,s=0,n=t.length;s<n;s++)e+=i.calculateNodeArea(t[s]);return e},_getBottom:function(t){var e=g.Common.Utils;return(e.getPosition(t).top||0)+(e.getSize(t).height||0)},_isIgnoredNode:function(t){return g.Common.Utils.includes(t.nodeName,this.ignoredNodeNames)},_eraseText:function(t){return t.replace(/[\n\r\s]/g,"")},_generatePartitionInformation:function(){for(var t,e=this.top,i=this.left,s=this.height,n=this.width,a=Math.floor(s/this.dividingHeight),r=s/a,o=[],h=0,d=0,u=0,l=0;h<a;)d=e+r*h,!0===(t=this._generatePartition(Math.round(d),Math.round(r+d),Math.round(i),Math.round(i+n))).isImage?u++:l++,o.push(t),h++;var c=n*r,g=this.totalRequiredTimeForReading,_=this.totalRequiredTimeForViewingImage;return this._setRecalculatedValueToPartitions({partitions:o,textSpeed:l*c/g,imageSpeed:u*c/_,textTime:g/l,imageTime:_/u}),{partitions:o,area:c,textPartitionCount:l,imagePartitionCount:u}},_setRecalculatedValueToPartitions:function(t){for(var e,i,s=(t=t||{}).partitions,n=t.textSpeed,a=t.imageSpeed,r=t.textTime,o=t.imageTime,h=0,d=s.length;h<d;h++)i=(e=s[h]).isImage,e.speed=!0===i?a:n,e.requiredTime=!0===i?o:r},_generatePartition:function(t,e,i,s){var n=s-i,a=e-t;return new r.Partition({width:n,height:a,top:t,left:i,right:s,bottom:e,isImage:this._isImagePartition(t,e,n,a)})},_isImagePartition:function(t,e,i,s){return this._calculateImageCoveredTotalPercentage(t,e,i,s,this.containedImageNodes)>this.imageAreaPercentage},_calculateImageCoveredTotalPercentage:function(t,e,i,s,n){for(var a=0,r=0,o=n.length;r<o;r++)a+=this._calculateImageCoveredPercentage(t,e,i,s,n[r]);return a},_calculateImageCoveredPercentage:function(t,e,i,s,n){var a=g.Common.Utils,r=a.getSize(n).width,o=a.getPosition(n),h=o.top,d=o.bottom;return t<=h&&h<e?(e-h)/s*r/i:t<=d&&d<=e?(d-t)/s*r/i:h<=t&&e<=d?r/i:0},_getVisiblePartition:function(t,e){return this.partitions.filter(this._checkPartitionVisibility.bind(null,t,e))},_checkPartitionVisibility:function(t,e,i){return i.checkVisible(t,e)&&i.currentPercentage<1},_calculateTotalPercentages:function(t){for(var e,i=t.length,s=0,n=0,a=0;a<i;)s+=(e=t[a]).currentPercentage,!0===e.isViewed&&n++,a++;return{currentReadingPercentage:Math.min(1,s/i),currentViewingPercentage:n/i}}})}(window.PopIn||{}),function(s){"use strict";s.createClass("Read.DebugStatusBar",function(t){t=t||{},this.width=t.width,this.height=t.height,this.x=t.x,this.y=t.y,this.textColour=t.textColour,this.imageColour=t.imageColour,this.opacity=t.opacity,this.incompletedOpacity=t.incompletedOpacity,this.completedOpacity=t.completedOpacity,this.node,this.lowerContext,this.upperContext,this.upperNode,this._textDrawn=!1},{CSS_OBJECT:{"._popIn_read_status_bar":{position:"absolute","box-shadow":"2px 2px 2px 2px #888888","border-radius":"10px",background:"#fff",overflow:"hidden","z-index":999999},"._popIn_read_status_bar_lower_canvas":{position:"relative",overflow:"hidden",opacity:.7,"z-index":0},"._popIn_read_status_bar_upper_canvas":{position:"absolute",overflow:"hidden",top:0,left:0,opacity:1,"z-index":1},"._popIn_read_status_bar.disabled":{display:"none"}},AREA_TEXT_FONT:"10px normal Meiryo, 'MS Gothic', sans-serif",TEXT_LABEL_NAME:"テキスト",IMAGE_LABEL_NAME:"画像",setup:function(){var t=s.Common,e=t.CSSManager;e.add(this.CSS_OBJECT),e.render();var i=new t.NodeBuilder({tagName:"div",classList:"_popIn_read_status_bar",property:{style:{width:this.width+"px",height:this.height+"px",top:this.y+"px",left:this.x+"px",opacity:this.opacity}},children:[{tagName:"canvas",classList:"_popIn_read_status_bar_lower_canvas",property:{width:this.width,height:this.height}},{tagName:"canvas",classList:"_popIn_read_status_bar_upper_canvas",property:{width:this.width,height:this.height}}]}).build();this.lowerContext=i.querySelector("._popIn_read_status_bar_lower_canvas").getContext("2d"),this.upperContext=i.querySelector("._popIn_read_status_bar_upper_canvas").getContext("2d"),this.node=i},update:function(t){var e,i=t.partitions,s=this.lowerContext;!1===this._textDrawn&&(this._drawTextsInUpperCanvas(i),this._textDrawn=!0),s.clearRect(0,0,this.width,this.height);for(var n=0,a=i.length;n<a;n++)e=i[n],this._drawPartition(e,s)},_drawTextsInUpperCanvas:function(t){for(var e,i,s,n=this.upperContext,a=0,r=t.length;a<r;a++)s!==(i=(e=t[a]).isImage)&&(this._drawText(e,n),s=i)},_drawPartition:function(t,e){e.fillStyle=!0===t.isImage?this.imageColour:this.textColour,e.globalAlpha=1<=t.currentPercentage?this.completedOpacity:this.incompletedOpacity,e.fillRect(0,t.top-this.y,Math.floor(this.width*t.currentPercentage),t.height)},_drawText:function(t,e){e.font=this.AREA_TEXT_FONT,e.textAlign="center",e.fillStyle="#fff",e.fillText(t.isImage?this.IMAGE_LABEL_NAME:this.TEXT_LABEL_NAME,Math.round(this.width/2),t.bottom-this.y,this.width)}})}(window.PopIn||{}),function(a){"use strict";var r=a.Read;a.createClass("Read.DebugStatusMonitor",function(t){t=t||{},this.width=t.width,this.height=t.height,this.x=t.x,this.y=t.y,this.minY=t.minY,this.maxY=t.maxY,this.country=t.country,this.node},{CLASS_NAME_VIEWING_PERCENTAGE:"_popIn_debug_status_viewing_percentage",CLASS_NAME_READING_PERCENTAGE:"_popIn_debug_status_reading_percentage",CLASS_NAME_CURRENT_READING_TIME:"_popIn_debug_status_current_time",CSS_OBJECT:{"._popIn_read_debug_status_monitor":{position:"absolute",display:"flex",transition:"all 0.15s ease-in-out","flex-direction":"column","justify-content":"space-evenly","align-items":"self-start","box-shadow":"2px 2px 2px 2px #888888","border-radius":"10px",overflow:"hidden",background:"#d9534f","font-size":"15px","font-weight":600,"letter-spacing":"initial",color:"#fff","line-height":1.5,"list-style":"none",padding:"10px",margin:0,"box-sizing":"border-box","z-index":999999},"._popIn_read_debug_status_monitor > li":{display:"block","font-size":"inherit","font-weight":"inherit","line-height":"inherit",background:"transparent",color:"inherit"},"._popIn_read_debug_status_monitor.disabled":{display:"none"}},setup:function(){var t=a.Common,e=t.CSSManager;e.add(this.CSS_OBJECT),e.render();var i=new t.NodeBuilder({tagName:"ul",classList:"_popIn_read_debug_status_monitor",property:{style:{top:this.y+"px",left:this.x+"px",width:this.width+"px",minHeight:this.height+"px"}},children:[{tagName:"li",classList:this.CLASS_NAME_VIEWING_PERCENTAGE},{tagName:"li",classList:this.CLASS_NAME_READING_PERCENTAGE},{tagName:"li",classList:this.CLASS_NAME_CURRENT_READING_TIME}]}).build();this._initialiseStatuses(i),this.node=i},_initialiseStatuses:function(t){var e,i=new a.Common.Message(this.country),s={viewingPercentage:{classList:this.CLASS_NAME_VIEWING_PERCENTAGE,format:i.get("read_debug_info_view")},readingPercentage:{classList:this.CLASS_NAME_READING_PERCENTAGE,format:i.get("read_debug_info_read")},currentReadingTime:{classList:this.CLASS_NAME_CURRENT_READING_TIME,format:i.get("read_debug_info_time")}};for(var n in s)e=s[n],this[n]=new r.DebugStatus({node:t.querySelector("."+e.classList),format:e.format})},update:function(t,e){"object"==typeof t&&this._updateMonitor(t),this._move(e)},_updateMonitor:function(t){this.viewingPercentage.update(Math.round(100*t.currentViewingPercentage)),this.readingPercentage.update(Math.round(100*t.currentReadingPercentage)),this.currentReadingTime.update(Math.floor(t.currentReadingTime))},_move:function(t){if(this.y!==t){var e=t>this.maxY?this.maxY:t<this.minY?this.minY:t;this.y=e,this.node.style.top=e+"px"}}})}(window.PopIn||{}),function(t){"use strict";(window.PopIn||{}).createClass("Read.DebugStatus",function(t){t=t||{},this.node=t.node,this.format=t.format,this.currentStatus=t.currentStatus||0},{update:function(t){this.currentStatus=t,this.node.textContent=this._formatValue(t)},_formatValue:function(t){return this.format.replace("{{value}}",t)}})}(),function(t,a){"use strict";var r=t.Read;t.createClass("Read.Debug",function(t){t=t||{},this.height=t.height,this.x=t.x,this.y=t.y,this.country=t.country,this.textColour=t.textColour||this.TEXT_COLOUR,this.imageColour=t.imageColour||this.IMAGE_COLOUR,this.statusBar,this.statusMonitor,this.enabled=!1},{BAR_WIDTH:45,MONITOR_WIDTH:140,MONITOR_HEIGHT:130,X_DISTANCE_FROM_ARTICLE:70,X_DISTANCE_BETWEEN_BAR_AND_MONITOR:10,TEXT_COLOUR:"#60C560",IMAGE_COLOUR:"#5BC0DE",BAR_OPACITY:1,OVERLAYED_BAR_OPACITY:.7,COMPLETED_OPACITY:1,INCOMPLETED_OPACITY:.6,MODULE_NAMES:["statusBar","statusMonitor"],setup:function(){var t=Math.max(this.x-this.X_DISTANCE_FROM_ARTICLE,0),e=new r.DebugStatusBar({width:this.BAR_WIDTH,height:this.height,x:t,y:this.y,opacity:0<t?this.BAR_OPACITY:this.OVERLAYED_BAR_OPACITY,imageColour:this.IMAGE_COLOUR,textColour:this.TEXT_COLOUR,incompletedOpacity:this.INCOMPLETED_OPACITY,completedOpacity:this.COMPLETED_OPACITY}),i=this.MONITOR_WIDTH+this.X_DISTANCE_BETWEEN_BAR_AND_MONITOR,s=new r.DebugStatusMonitor({width:this.MONITOR_WIDTH,height:this.MONITOR_HEIGHT,x:i<t?t-i:t+this.BAR_WIDTH+this.X_DISTANCE_BETWEEN_BAR_AND_MONITOR,y:this.y,minY:this.y,maxY:this.y+this.height-this.MONITOR_HEIGHT,country:this.country});e.setup(),s.setup();var n=a.body;n.appendChild(e.node),n.appendChild(s.node),this.statusBar=e,this.statusMonitor=s,this.enabled=!0},update:function(t,e){"object"==typeof t&&this.statusBar.update(t),this.statusMonitor.update(t,e)},changeEnabled:function(t){for(var e,i=!0===(this.enabled=t)?"remove":"add",s=this.MODULE_NAMES,n=0,a=s.length;n<a;n++)void 0!==(e=this[s[n]])&&e.node.classList[i]("disabled")}})}(window.PopIn,document),function(t){"use strict";(window.PopIn||{}).createClass("Read.Partition",function(t){t=t||{},this.width=t.width,this.height=t.height,this.top=t.top||0,this.right=t.right||0,this.left=t.left||0,this.bottom=t.bottom||0,this.speed=t.speed||0,this.requiredTime=t.requiredTime||0,this.isImage=t.isImage||!1,this.currentPercentage=0,this.currentTime=0,this.isFinished=!1,this.isViewed=!1,this.isUpdated=!1},{update:function(t){if(!(this.isUpdated=!1)!==this.isFinished){var e=this.currentPercentage,i=Math.min(1,e+t*this.speed);this.currentTime=this.requiredTime*i,this.isFinished=1<=i,this.isViewed=0<i,this.isUpdated=i!==e,this.currentPercentage=i}},checkVisible:function(t,e){return this.isVisible=this.top>t&&this.bottom<e}})}(),function(t,e,i){"use strict";t.inherit("Read.Timer","Common.Publisher",function(t){t=t||{},this.interval=t.interval||1,this.maxElapsed=t.maxElapsed||1,this.elapsed=0,this.currentTime,this._isStarted=!1,this._timer=null},{start:function(){null===this._timer&&(!1===this._isStarted&&(this._addEvent(),this._isStarted=!0),this.currentTime=Date.now(),this._timer=setInterval(this._update.bind(this),this.interval))},stop:function(){null!==this._timer&&(clearInterval(this._timer),this._timer=null)},_update:function(){var t=this.currentTime,e=Date.now(),i=(e-t)/1e3;this.currentTime=e,i>this.maxElapsed||(this.elapsed=i,this.trigger("update",this))},_addEvent:function(){e.addEventListener("visibilitychange",this._toggleActive.bind(this),!1)},_toggleActive:function(){!0===i.hidden?this.stop():this.start()}})}(window.PopIn,window,document),function(a,l,r,o){"use strict";var t=a.PROTOCOL;a.createClass("Read",["Common.Logger","Common.Publisher"],function(t){t=t||{},this.media=t.media||o.host,this.apiUrl=t.apiUrl,this.urlReplace=t.urlReplace||[],this.mainNode=t.mainNode,this.mainNodeElement=t.mainNodeElement,this.stopNode=t.stopNode,this.useUser=t.useUser||!1,this.ignoredNodeNames=t.ignoredNodeNames||void 0,this.category=t.category||!1,this.isMultiple=t.isMultiple||!1,this.shouldContinueToUpdate=t.shouldContinueToUpdate||!1,this.needRecommendInformation=t.needRecommendInformation||!1,this.customEvents=t.customEvents||void 0,this.textSpeed=t.textSpeed||this.DEFAULT_TEXT_SPEED,this.imageSpeed=t.imageSpeed||this.DEFAULT_IMAGE_SPEED,this.findingNodeInterval=t.findingNodeInterval||this.FINDING_NODE_INTERVAL,this.delay=t.delay||0,this.device,this.currentUrl,this.analyisStopNode,this.popInUserId,this.customValueMap,this.country,this.commonCategory=[],this.sendLogTiming,this.findNodeTiming,this.articleReadId,this.updateCount=0,this.delayAnalysis=!1,this.isAnalysing=!1;var e=this.constructor;if(void 0===e._analysedArticleNodes&&(e._analysedArticleNodes=[]),void 0===e._analysers&&(e._analysers=[]),void 0===e._isDebug&&(e._isDebug=!1),void 0===e._timer){var i=new e.Timer({interval:this.UPDATE_INTERVAL,maxElapsed:this.VALID_MAX_ELAPSED});i.on("update",this._update.bind(this)),e._timer=i}},{POPIN_AD_DOMAIN:"a.popin.cc",CLICK_HISTORY_API_URL:t+"//discoveryplus.popin.cc/popin_discovery/ck?name=_click",DEFAULT_TEXT_SPEED:1e3/60,DEFAULT_IMAGE_SPEED:9e4,UPDATE_INTERVAL:100,VALID_MAX_ELAPSED:.15,SEND_LOG_INTERVAL:2e3,FINDING_NODE_INTERVAL:4e3,INTERVAL_TO_RETRY_ANALYSIS:100,MAX_ELAPSED_SECONDS_FROM_AD_CLICK:10,READ_TIMPSTAMP_SESSION_STORAGE_KEY:"__read_id",CAN_ANALYSE_SESSION_STORAGE_KEY:"__read_rand",PERCENTAGE_TO_ANALYSE:.5,setup:function(){var t=this.constructor;t._isDebug=t._isDebug||/popinread=true/.test(o.href),this.logger=a.Common.Logger,this.delayAnalysis=0<this.delay,this.sendLogTiming=Math.round(this.SEND_LOG_INTERVAL/this.UPDATE_INTERVAL),this.findNodeTiming=!0===this.isMultiple?Math.round(this.findingNodeInterval/this.UPDATE_INTERVAL):void 0,this.isClickedAd=-1<r.referrer.indexOf(this.POPIN_AD_DOMAIN);var e=a.Common.Storage;this.sessionHistory=e.get("session",t.Analyser.prototype.READ_HISTORY_SESSION_STORAGE_KEY);var i=e.get("session",this.READ_TIMPSTAMP_SESSION_STORAGE_KEY);return this.isNewSession=null===i,!0===this.isNewSession&&(e.set("session",this.READ_TIMPSTAMP_SESSION_STORAGE_KEY,"s"+Date.now()),e.set("session",this.CAN_ANALYSE_SESSION_STORAGE_KEY,!0===this.isClickedAd||Math.random()<this.PERCENTAGE_TO_ANALYSE)),this.canAnalyse="true"===e.get("session",this.CAN_ANALYSE_SESSION_STORAGE_KEY),this.needRecommendInformation=this.needRecommendInformation||!0===this.category||!0===this.useUser,this.customValueMap=this._generateCustomValueMap(),this.analyisStopNode=this.stopNode?r.querySelector(this.stopNode):void 0,this.mainNodeElement?this._load(this.mainNodeElement):this._initialiseAnalyserBySelector(this.mainNode)},_initialiseAnalyserBySelector:function(t){var e=r.querySelector(t);null!==e&&!1===this._isAnalysed(e)&&this._load(e)},_initialiseAnalysersBySelector:function(t){var e,i=Array.apply(null,r.querySelectorAll(t));if(0===i.length)return!1;for(var s=0,n=i.length;s<n;s++)e=i[s],!1===this._isAnalysed(e)&&this._load(e)},_load:function(t){this.constructor._analysedArticleNodes.push(t);var e=new a.Common.Loader({target:o.href,apiUrl:this.apiUrl,apiUrlAdd:"&related=false",urlReplace:this.urlReplace,needRecommendInformation:this.needRecommendInformation});e.on("response",this._onResponse.bind(this,t)),e.load()},_isAnalysed:function(t){return a.Common.Utils.includes(t,this.constructor._analysedArticleNodes)},_onResponse:function(t,e){this._updateInformation(e),!0===this.isClickedAd?a.Common.Utils.requestByJSONP(this.CLICK_HISTORY_API_URL,this._onAdInformationResponse.bind(this,t)):this._initialiseAnalyser(t)},_onAdInformationResponse:function(t,e){if("object"==typeof e){var i=this._getAdInformation(e);"object"==typeof i&&this._initialiseAnalyser(t,i)}},_getAdInformation:function(t){var e=t._click;if(!e)return!1;var i=parseInt(t.time),s=e.split("|").pop().split(".");if(s.length<2)return!1;var n=s[1],a=s[2];return(i-parseInt(a))/1e3<this.MAX_ELAPSED_SECONDS_FROM_AD_CLICK&&{campaign:s[0],nid:n,media:n,clickCategory:s[3]}},_updateInformation:function(t){this.currentUrl=t.target,this.device=t.device,this.referrer=t.referrer,this.popInUserId=t.popInUserId,this.country=t.country,this.apiHost=t.apiHost;var e=t.responseData||{};this.pageCategory=e.category,this.commonCategory=e.common_category||[],this.articleReadId=e.article_read},_generateCustomValueMap:function(){var t,e,i,s={},n=l._pop;if(!n)return s;for(var a=0,r=n.length;a<r;a++)i=(t=n[a])[0],e=t[1],s[i.substring(5)]=e;return s},_initialiseAnalyser:function(t,e){if(e=e||{},!1===this._shouldAnalyse())return!1;if("complete"===r.readyState){if(!0===this.delayAnalysis)return setTimeout(this._initialiseAnalyser.bind(this,t,e),this.delay),void(this.delayAnalysis=!1);var i=this.constructor,s=a.Common.Utils,n=new i.Analyser({node:t,textSpeed:this.textSpeed,imageSpeed:this.imageSpeed,sendLogTiming:this.sendLogTiming,stopNode:this.analyisStopNode,media:e.media||this.media,campaign:e.campaign,clickCategory:e.clickCategory,device:this.device,sessionHistory:this.sessionHistory,nid:e.nid||s.digest(o.host)+s.digest(this.currentUrl),popInUserId:!0===this.useUser?this.popInUserId:"",commonCategory:this.commonCategory[0],apiHost:this.apiHost,ignoredNodeNames:this.ignoredNodeNames,pageCategory:this.customValueMap.read_categoryName||(!0===this.category?this.pageCategory||"all":void 0),customField:this.customValueMap.read_customField,url:this.currentUrl,urlReplace:this.urlReplace,country:this.country,referrer:this.referrer,isDebug:i._isDebug,isNewSession:this.isNewSession,isClickedAd:this.isClickedAd,articleReadId:this.articleReadId,logger:this.logger});"object"==typeof this.customEvents&&this._registerEvents(n,this.customEvents),n.setup(),i._analysers.push(n),!1===this.isAnalysing&&(i._timer.start(),this.isAnalysing=!0)}else setTimeout(this._initialiseAnalyser.bind(this,t,e),this.INTERVAL_TO_RETRY_ANALYSIS)},_shouldAnalyse:function(){return void 0!==this.articleReadId||!0===this.constructor._isDebug||!0===this.canAnalyse},_registerEvents:function(t,e){var i;for(var s in e)"function"==typeof(i=e[s])&&t.on(s,i)},_update:function(t){this.updateCount++,!0===this.isMultiple&&this.updateCount%this.findNodeTiming==0&&this._initialiseAnalysersBySelector(this.mainNode);for(var e,i=l.pageYOffset,s=i+l.innerHeight,n=this.constructor,a=n._analysers,r=this.shouldContinueToUpdate,o=n._isDebug,h=t.elapsed,d=0,u=a.length;d<u;d++)(e=a[d]).update(h,i,s),!1===r&&!1===o&&!0===e.isCompleted&&(a.splice(d,1),d--,u--);!1===this.isMultiple&&0===a.length&&n._timer.stop()}})}(window.PopIn,window,document,location);